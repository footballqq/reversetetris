var lt=Object.defineProperty;var rt=(n,t,e)=>t in n?lt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var h=(n,t,e)=>rt(n,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();const v=class v{constructor(t){h(this,"_grid");h(this,"_ceilingRows",0);t?this._grid=t.map(e=>[...e]):this._grid=Array.from({length:v.TOTAL_ROWS},()=>Array(v.WIDTH).fill(0))}get data(){return this._grid}get ceilingRows(){return this._ceilingRows}getSpawnY(){return v.VISIBLE_START_ROW+this._ceilingRows}lowerCeiling(t=1){const e=Math.min(v.VISIBLE_ROWS,Math.max(0,this._ceilingRows+t));this._ceilingRows=e}isCeilingRow(t){return t>=v.VISIBLE_START_ROW&&t<v.VISIBLE_START_ROW+this._ceilingRows}isCellEmpty(t,e){return t<0||t>=v.WIDTH||e>=v.TOTAL_ROWS?!1:e<0?!0:this.isCeilingRow(e)?!1:this._grid[e][t]===0}isValidPosition(t,e,i,s={}){for(const a of t){const r=e+a.x,l=i+a.y;if(r<0||r>=v.WIDTH||l>=v.TOTAL_ROWS||!s.ignoreCeiling&&l>=0&&this.isCeilingRow(l)||l>=0&&this._grid[l][r]!==0)return!1}return!0}lockPiece(t,e,i,s){for(const a of t){const r=e+a.x,l=i+a.y;r>=0&&r<v.WIDTH&&l>=0&&l<v.TOTAL_ROWS&&(this._grid[l][r]=s)}}isPieceTouchingCeiling(t,e,i){const s=this.getSpawnY();for(const a of t)if(i+a.y<s)return!0;return!1}clearLines(){let t=0;for(let e=v.TOTAL_ROWS-1;e>=0;e--)this.isRowFull(e)&&(this.removeRow(e),t++,e++);return t}isRowFull(t){return this._grid[t].every(e=>e!==0)}removeRow(t){this._grid.splice(t,1),this._grid.unshift(Array(v.WIDTH).fill(0))}isGameOver(){const t=this.getSpawnY();for(let e=0;e<t;e++)if(this._grid[e].some(i=>i!==0))return!0;return!1}getHeight(){for(let t=0;t<v.TOTAL_ROWS;t++)if(this._grid[t].some(e=>e!==0))return v.TOTAL_ROWS-t;return 0}countHoles(){let t=0;for(let e=0;e<v.WIDTH;e++){let i=!1;for(let s=0;s<v.TOTAL_ROWS;s++)this._grid[s][e]!==0?i=!0:i&&this._grid[s][e]===0&&t++}return t}countBlockades(){let t=0;for(let e=0;e<v.WIDTH;e++){let i=!1;for(let s=v.TOTAL_ROWS-1;s>=0;s--)this._grid[s][e]===0?i=!0:i&&t++}return t}getWellSums(){let t=0;for(let e=0;e<v.WIDTH;e++){let i=0;for(let s=0;s<v.TOTAL_ROWS;s++){if(this._grid[s][e]!==0){i=0;continue}const a=e===0?!0:this._grid[s][e-1]!==0,r=e===v.WIDTH-1?!0:this._grid[s][e+1]!==0;a&&r?(i+=1,t+=i):i=0}}return t}getAggregateHeight(){let t=0;for(let e=0;e<v.WIDTH;e++)for(let i=0;i<v.TOTAL_ROWS;i++)if(this._grid[i][e]!==0){t+=v.TOTAL_ROWS-i;break}return t}getBumpiness(){let t=0,e=this.getColumnHeight(0);for(let i=1;i<v.WIDTH;i++){const s=this.getColumnHeight(i);t+=Math.abs(e-s),e=s}return t}getColumnHeight(t){for(let e=0;e<v.TOTAL_ROWS;e++)if(this._grid[e][t]!==0)return v.TOTAL_ROWS-e;return 0}clone(){const t=new v;return t._grid=this._grid.map(e=>[...e]),t._ceilingRows=this._ceilingRows,t}};h(v,"WIDTH",10),h(v,"HEIGHT",20),h(v,"TOTAL_ROWS",22),h(v,"VISIBLE_ROWS",20),h(v,"VISIBLE_START_ROW",2);let S=v;var c=(n=>(n.I="I",n.O="O",n.T="T",n.S="S",n.Z="Z",n.J="J",n.L="L",n.LONG_I="LONG_I",n.CROSS="CROSS",n.SQUARE_HOLLOW="SQUARE_HOLLOW",n.PENTO_U="PENTO_U",n.PENTO_W="PENTO_W",n.PENTO_F="PENTO_F",n.PENTO_Y="PENTO_Y",n.PENTO_V="PENTO_V",n.SNAKE_5="SNAKE_5",n.SNAKE_6="SNAKE_6",n.DOORFRAME_7="DOORFRAME_7",n))(c||{});const ct={[c.I]:[[[-1,0],[0,0],[1,0],[2,0]],[[1,-1],[1,0],[1,1],[1,2]],[[-1,1],[0,1],[1,1],[2,1]],[[0,-1],[0,0],[0,1],[0,2]]],[c.O]:[[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]]],[c.T]:[[[0,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[0,1]]],[c.S]:[[[0,-1],[1,-1],[-1,0],[0,0]],[[0,-1],[0,0],[1,0],[1,1]],[[0,0],[1,0],[-1,1],[0,1]],[[-1,-1],[-1,0],[0,0],[0,1]]],[c.Z]:[[[-1,-1],[0,-1],[0,0],[1,0]],[[1,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[0,1],[1,1]],[[0,-1],[-1,0],[0,0],[-1,1]]],[c.J]:[[[-1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[1,-1],[0,0],[0,1]],[[-1,0],[0,0],[1,0],[1,1]],[[0,-1],[0,0],[-1,1],[0,1]]],[c.L]:[[[1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[1,0],[-1,1]],[[-1,-1],[0,-1],[0,0],[0,1]]],[c.LONG_I]:[[[-2,0],[-1,0],[0,0],[1,0],[2,0],[3,0]],[[0,-2],[0,-1],[0,0],[0,1],[0,2],[0,3]],[[-2,0],[-1,0],[0,0],[1,0],[2,0],[3,0]],[[0,-2],[0,-1],[0,0],[0,1],[0,2],[0,3]]],[c.CROSS]:[[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]]],[c.SQUARE_HOLLOW]:[[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]]],[c.PENTO_U]:[[[-1,-1],[1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[0,1],[1,-1],[1,1]],[[-1,0],[0,0],[1,0],[-1,1],[1,1]],[[-1,-1],[-1,1],[0,-1],[0,0],[0,1]]],[c.PENTO_W]:[[[-1,-1],[-1,0],[0,0],[0,1],[1,1]],[[1,-1],[0,-1],[0,0],[-1,0],[-1,1]],[[1,1],[1,0],[0,0],[0,-1],[-1,-1]],[[-1,1],[0,1],[0,0],[1,0],[1,-1]]],[c.PENTO_V]:[[[0,-2],[0,-1],[0,0],[1,0],[2,0]],[[2,-2],[1,-2],[0,-2],[0,-1],[0,0]],[[2,0],[2,-1],[2,-2],[1,-2],[0,-2]],[[0,0],[1,0],[2,0],[2,-1],[2,-2]]],[c.PENTO_Y]:[[[0,-1],[0,0],[0,1],[0,2],[1,0]],[[-1,0],[0,0],[1,0],[2,0],[0,-1]],[[0,-2],[0,-1],[0,0],[0,1],[-1,0]],[[-2,0],[-1,0],[0,0],[1,0],[0,1]]],[c.PENTO_F]:[[[0,-1],[1,-1],[-1,0],[0,0],[0,1]],[[1,0],[1,1],[0,-1],[0,0],[-1,0]],[[0,-1],[0,0],[1,0],[-1,1],[0,1]],[[1,0],[0,0],[0,1],[-1,-1],[-1,0]]],[c.SNAKE_5]:[[[0,-1],[1,-1],[-1,0],[0,0],[1,1]],[[1,0],[1,1],[0,-1],[0,0],[-1,-1]],[[-1,-1],[0,0],[1,0],[-1,1],[0,1]],[[1,-1],[0,-1],[0,0],[-1,0],[-1,1]]],[c.SNAKE_6]:[[[0,-1],[1,-1],[-1,0],[0,0],[0,1],[1,1]],[[1,0],[1,1],[0,-1],[0,0],[-1,0],[-1,1]],[[-1,-1],[0,-1],[0,0],[1,0],[-1,1],[0,1]],[[1,-1],[0,-1],[0,0],[-1,0],[1,0],[0,1]]],[c.DOORFRAME_7]:[[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[1,1]],[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,1]],[[-1,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]]]},ht={[c.I]:"#00f0f0",[c.O]:"#f0f000",[c.T]:"#a000f0",[c.S]:"#00f000",[c.Z]:"#f00000",[c.J]:"#0000f0",[c.L]:"#f0a000",[c.LONG_I]:"#FFD700",[c.CROSS]:"#FFD700",[c.SQUARE_HOLLOW]:"#FF3BFF",[c.PENTO_U]:"#FF3BFF",[c.PENTO_W]:"#FF3BFF",[c.PENTO_F]:"#FF3BFF",[c.PENTO_Y]:"#FF3BFF",[c.PENTO_V]:"#FF3BFF",[c.SNAKE_5]:"#FF3BFF",[c.SNAKE_6]:"#FF3BFF",[c.DOORFRAME_7]:"#FF3BFF"},Z={[c.I]:1,[c.O]:2,[c.T]:3,[c.S]:4,[c.Z]:5,[c.J]:6,[c.L]:7,[c.LONG_I]:8,[c.CROSS]:8,[c.SQUARE_HOLLOW]:9,[c.PENTO_U]:9,[c.PENTO_W]:9,[c.PENTO_F]:9,[c.PENTO_Y]:9,[c.PENTO_V]:9,[c.SNAKE_5]:9,[c.SNAKE_6]:9,[c.DOORFRAME_7]:9},dt={1:"#00f0f0",2:"#f0f000",3:"#a000f0",4:"#00f000",5:"#f00000",6:"#0000f0",7:"#f0a000",8:"#FFD700",9:"#FF3BFF"};class ut{constructor(){h(this,"particles",[]);h(this,"texts",[]);h(this,"shakeX",0);h(this,"shakeY",0);h(this,"shakeTime",0)}update(t){if(this.particles=this.particles.filter(e=>(e.x+=e.vx*(t/16),e.y+=e.vy*(t/16),e.life-=t,e.life>0)),this.texts=this.texts.filter(e=>(e.y+=e.vy*(t/16),e.life-=t,e.life>0)),this.shakeTime>0){this.shakeTime-=t;const e=Math.min(10,this.shakeTime/20);this.shakeX=(Math.random()-.5)*e,this.shakeY=(Math.random()-.5)*e}else this.shakeX=0,this.shakeY=0}draw(t){this.particles.forEach(e=>{t.globalAlpha=e.life/e.maxLife,t.fillStyle=e.color,t.fillRect(e.x,e.y,e.size,e.size)}),t.globalAlpha=1,this.texts.forEach(e=>{t.globalAlpha=e.life/e.maxLife,t.fillStyle=e.color,t.font="bold 20px Arial",t.fillText(e.text,e.x,e.y)}),t.globalAlpha=1}getShake(){return{x:this.shakeX,y:this.shakeY}}spawnParticles(t,e,i,s=10){for(let a=0;a<s;a++)this.particles.push({x:t,y:e,vx:(Math.random()-.5)*5,vy:(Math.random()-.5)*5,life:500+Math.random()*500,maxLife:1e3,color:i,size:2+Math.random()*3})}spawnText(t,e,i,s="#fff"){this.texts.push({x:t,y:e,text:i,color:s,life:1e3,maxLife:1e3,vy:-1})}triggerShake(t=200){this.shakeTime=t}}class gt{constructor(t){h(this,"canvas");h(this,"ctx");h(this,"width",800);h(this,"height",600);h(this,"animator");h(this,"layout",{cellSize:24,gridX:0,gridY:0,gridWidth:0,gridHeight:0,selectionY:20,selectionHeight:80,selectionX:0,slotWidth:0,isPortrait:!1});h(this,"VISIBLE_START_ROW",2);this.canvas=t,this.ctx=t.getContext("2d"),this.animator=new ut,this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}handleResize(){const t=window.devicePixelRatio||1;this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width*t,this.canvas.height=this.height*t,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t),this.recalculateLayout()}recalculateLayout(){const t=S.WIDTH,e=S.TOTAL_ROWS-this.VISIBLE_START_ROW,i=this.height>this.width;if(this.layout.isPortrait=i,this.layout.selectionHeight=70,i){this.layout.selectionY=6,this.layout.selectionHeight=58;const s=this.layout.selectionY+this.layout.selectionHeight+10,a=this.height-s-105,r=this.width-12,l=Math.floor(a/e),u=Math.floor(r/t);let o=Math.min(l,u);o=Math.min(o,48),o=Math.max(o,12),this.layout.cellSize=o,this.layout.gridWidth=t*o,this.layout.gridHeight=e*o,this.layout.gridX=Math.floor((this.width-this.layout.gridWidth)/2),this.layout.gridY=s}else{this.layout.selectionY=15;const s=this.width-200,a=this.height-130,r=Math.floor(a/e),l=Math.floor(s/t);let u=Math.min(r,l);u=Math.min(u,30),u=Math.max(u,15),this.layout.cellSize=u,this.layout.gridWidth=t*u,this.layout.gridHeight=e*u,this.layout.gridX=Math.floor((this.width-this.layout.gridWidth)/2)-60,this.layout.gridY=110}this.layout.selectionX=this.layout.gridX,this.layout.slotWidth=this.layout.gridWidth/3}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.width,this.height),this.animator.draw(this.ctx)}update(t){this.animator.update(t)}drawAnimations(){this.animator.draw(this.ctx)}drawGrid(t){const e=this.animator.getShake();this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.fillStyle="#111",this.ctx.fillRect(this.layout.gridX,this.layout.gridY,this.layout.gridWidth,this.layout.gridHeight),this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let o=0;o<=S.WIDTH;o++){const d=this.layout.gridX+o*this.layout.cellSize;this.ctx.moveTo(d,this.layout.gridY),this.ctx.lineTo(d,this.layout.gridY+this.layout.gridHeight)}for(let o=0;o<=S.TOTAL_ROWS-this.VISIBLE_START_ROW;o++){const d=this.layout.gridY+o*this.layout.cellSize;this.ctx.moveTo(this.layout.gridX,d),this.ctx.lineTo(this.layout.gridX+this.layout.gridWidth,d)}this.ctx.stroke(),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.strokeRect(this.layout.gridX-2,this.layout.gridY-2,this.layout.gridWidth+4,this.layout.gridHeight+4);const s=t.ceilingRows*this.layout.cellSize;this.ctx.fillStyle="rgba(10, 10, 10, 0.85)",this.ctx.fillRect(this.layout.gridX,this.layout.gridY,this.layout.gridWidth,s);const a=this.layout.gridY+s,r=performance.now()/1e3,l=(Math.sin(r*3)+1)/2;this.ctx.save(),this.ctx.shadowBlur=8+4*l,this.ctx.shadowColor="#ff3333",this.ctx.strokeStyle=`rgba(255, 50, 50, ${.7+.3*l})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(this.layout.gridX-2,a),this.ctx.lineTo(this.layout.gridX+this.layout.gridWidth+2,a),this.ctx.stroke(),this.ctx.restore();const u=t.data;for(let o=this.VISIBLE_START_ROW;o<S.TOTAL_ROWS;o++)for(let d=0;d<S.WIDTH;d++){const p=u[o][d],f=dt[p];p!==0&&f&&this.drawCell(this.layout.gridX+d*this.layout.cellSize,this.layout.gridY+(o-this.VISIBLE_START_ROW)*this.layout.cellSize,f)}this.ctx.restore()}drawPiece(t,e,i,s){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y);const r=t.getBlocks(s),l=t.getColor();for(const u of r){const o=this.layout.gridX+(e+u.x)*this.layout.cellSize,d=this.layout.gridY+(i+u.y-this.VISIBLE_START_ROW)*this.layout.cellSize;i+u.y>=this.VISIBLE_START_ROW&&this.drawCell(o,d,l)}this.ctx.restore()}drawGhostPiece(t,e,i,s){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y),this.ctx.globalAlpha=.3;const r=t.getBlocks(s),l=t.getColor();for(const u of r){const o=this.layout.gridX+(e+u.x)*this.layout.cellSize,d=this.layout.gridY+(i+u.y-this.VISIBLE_START_ROW)*this.layout.cellSize;i+u.y>=this.VISIBLE_START_ROW&&this.drawCell(o,d,l,!0)}this.ctx.globalAlpha=1,this.ctx.restore()}drawCell(t,e,i,s=!1){const a=this.layout.cellSize-2;if(this.ctx.fillStyle=i,this.ctx.fillRect(t+1,e+1,a,a),s||(this.ctx.fillStyle="rgba(255,255,255,0.3)",this.ctx.fillRect(t+1,e+1,a,a/3)),!s&&i==="#FFD700"){const r=performance.now()/500,l=(Math.sin(r)+1)/2*.4+.1;this.ctx.save(),this.ctx.strokeStyle=`rgba(255, 255, 200, ${l})`,this.ctx.lineWidth=2,this.ctx.shadowBlur=10,this.ctx.shadowColor="#FFD700",this.ctx.strokeRect(t+2,e+2,a-2,a-2),this.ctx.restore()}}drawPieceSelector(t,e){this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.strokeRect(this.layout.selectionX-2,this.layout.selectionY-2,this.layout.gridWidth+4,this.layout.selectionHeight+4),this.ctx.fillStyle="#aaa",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText("CANDIDATES",this.layout.selectionX,this.layout.selectionY-8);const i=this.layout.slotWidth;t.forEach((s,a)=>{const r=this.layout.selectionX+a*i+i/2;a===e&&(this.ctx.fillStyle="rgba(255,255,255,0.1)",this.ctx.fillRect(this.layout.selectionX+a*i,this.layout.selectionY,i,this.layout.selectionHeight));const l=s.getBlocks(),u=s.getColor();let o=1/0,d=-1/0,p=1/0,f=-1/0;for(const I of l)o=Math.min(o,I.x),d=Math.max(d,I.x),p=Math.min(p,I.y),f=Math.max(f,I.y);const m=d-o+1||1,L=f-p+1||1,b=6,M=6,w=16,O=Math.max(10,i-b*2),E=Math.max(10,this.layout.selectionHeight-M*2-w),y=Math.min(14,this.layout.cellSize*.55),A=Math.max(4,Math.min(y,Math.floor(O/m),Math.floor(E/L))),V=m*A,K=L*A,P=this.layout.selectionX+a*i,z=this.layout.selectionY,st=P+i/2,at=z+(this.layout.selectionHeight-w)/2,nt=st-V/2-o*A,ot=at-K/2-p*A;this.ctx.save(),this.ctx.beginPath(),this.ctx.rect(P+1,z+1,i-2,this.layout.selectionHeight-2),this.ctx.clip();for(const I of l){const q=nt+I.x*A,Q=ot+I.y*A,F=A-1;this.ctx.fillStyle=u,this.ctx.fillRect(q,Q,F,F),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(q,Q,F,F/3)}this.ctx.restore(),this.ctx.fillStyle="#888",this.ctx.font="10px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${a+1}`,r,this.layout.selectionY+this.layout.selectionHeight-5)})}drawUI(t,e,i,s,a,r,l,u){this.ctx.textAlign="left",this.ctx.font="12px Arial";let o,d;if(this.layout.isPortrait){o=this.layout.gridX,d=this.layout.gridY+this.layout.gridHeight+16;const p=38,f=Math.floor(this.layout.gridWidth/3);this.drawText("SCORE",o,d,11,"#aaa"),this.drawText(`${t}`,o,d+16,17,"#fff"),this.drawText("LEVEL",o+f,d,11,"#aaa"),this.drawText(`${e}`,o+f,d+16,17,"#fff"),this.drawText("BLOCKS",o+f*2,d,11,"#aaa"),this.drawText(`${a}`,o+f*2,d+16,17,"#fff");const m=d+p;this.drawText("AI LINES",o,m,11,"#aaa"),this.drawText(`${i}/${s}`,o,m+16,17,"#fff"),r&&(this.drawText("DIFFICULTY",o+f,m,10,"#aaa"),this.drawText(`${r.toUpperCase()}`,o+f,m+16,15,"#fff"));const L=m+p+10;if(this.drawText("AI wins at target. You win if AI tops out.",o,L,10,"#666"),u&&(this.ctx.textAlign="right",this.drawText(u,this.layout.gridX+this.layout.gridWidth,L+12,10,"#444"),this.ctx.textAlign="left"),l){this.ctx.textAlign="right";const b=this.layout.gridX+this.layout.gridWidth;this.drawText(`H:${l.holes} W:${l.wellSums}`,b,m+16,10,"#888"),this.ctx.textAlign="left"}}else{o=this.layout.gridX+this.layout.gridWidth+20,d=this.layout.gridY;const p=this.layout.gridY+this.layout.gridHeight;if(this.drawText("SCORE",o,d+20,14,"#aaa"),this.drawText(`${t}`,o,d+50,24,"#fff"),this.drawText("LEVEL",o,d+100,14,"#aaa"),this.drawText(`${e}`,o,d+130,24,"#fff"),this.drawText("AI LINES",o,d+180,14,"#aaa"),this.drawText(`${i}/${s}`,o,d+210,24,"#fff"),this.drawText("BLOCKS",o,d+260,14,"#aaa"),this.drawText(`${a}`,o,d+290,24,"#fff"),this.drawText("AI wins at target lines.",o,d+318,12,"#666"),this.drawText("You win if AI tops out.",o,d+336,12,"#666"),r&&(this.drawText("DIFFICULTY",o,d+360,14,"#aaa"),this.drawText(`${r.toUpperCase()}`,o,d+390,22,"#fff")),l){const f=d+430;this.drawText(`HOLES ${l.holes} (+${l.holesCreated})`,o,f,14,"#aaa"),this.drawText(`BLOCK ${l.blockades}   WELLS ${l.wellSums}`,o,f+24,14,"#aaa"),l.lastMove&&this.drawText(`PRED H${l.lastMove.holes} (+${l.lastMove.holesCreated}) B${l.lastMove.blockades} W${l.lastMove.wellSums} L${l.lastMove.linesCleared}`,o,f+48,12,"#888")}u&&this.drawText(u,o,p-18,12,"#666"),this.drawText("D:DEBUG  V:VERSION  S:LOG",o,p-2,12,"#555")}}drawText(t,e,i,s=30,a="#fff",r="left"){this.ctx.fillStyle=a,this.ctx.font=`${s}px Arial`,this.ctx.textAlign=r,this.ctx.fillText(t,e,i)}}class ${constructor(t){h(this,"type");h(this,"_rotation");this.type=t,this._rotation=0}get rotation(){return this._rotation}rotateClockwise(){this._rotation=(this._rotation+1)%4}rotateCounterClockwise(){this._rotation=(this._rotation+3)%4}setRotation(t){this._rotation=t%4}getBlocks(t){const e=t!==void 0?t%4:this._rotation;return ct[this.type][e].map(([a,r])=>({x:a,y:r}))}getColor(){return ht[this.type]}clone(){const t=new $(this.type);return t.setRotation(this._rotation),t}}class W{static createRandom(t){const e=(t==null?void 0:t.specialChance)??0;if(Math.random()<e){const s=this.helpfulSpecialTypes[Math.floor(Math.random()*this.helpfulSpecialTypes.length)];return new $(s)}this.bag.length===0&&this.refillBag();const i=this.bag.pop();return new $(i)}static createRandomSet(t,e){var d,p,f,m;const i=[],s=(e==null?void 0:e.specialChance)??0,a=((d=e==null?void 0:e.toxicRules)==null?void 0:d.enabled)??!0,r=Math.max(1,Math.floor(((p=e==null?void 0:e.toxicRules)==null?void 0:p.everyTurns)??8)),l=Math.max(0,Math.floor(((f=e==null?void 0:e.toxicRules)==null?void 0:f.cooldownTurns)??6)),u=Math.max(0,Math.floor(((m=e==null?void 0:e.toxicRules)==null?void 0:m.maxPerSet)??1));a&&(this.toxicToken=Math.min(1,this.toxicToken+1/r),this.toxicCooldownRemaining>0&&(this.toxicCooldownRemaining-=1));let o=-1;a&&u>0&&t>0&&this.toxicCooldownRemaining===0&&this.toxicToken>=1&&(o=Math.floor(Math.random()*t),this.toxicToken-=1,this.toxicCooldownRemaining=l);for(let L=0;L<t;L++)if(L===o){const b=this.toxicTypes[Math.floor(Math.random()*this.toxicTypes.length)];i.push(new $(b))}else i.push(this.createRandom({specialChance:s}));return i}static refillBag(){this.bag=[...this.types];for(let t=this.bag.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[this.bag[t],this.bag[e]]=[this.bag[e],this.bag[t]]}}}h(W,"types",[c.I,c.O,c.T,c.S,c.Z,c.J,c.L]),h(W,"bag",[]),h(W,"helpfulSpecialTypes",[c.LONG_I,c.CROSS]),h(W,"toxicTypes",[c.SQUARE_HOLLOW,c.PENTO_U,c.PENTO_W,c.PENTO_F,c.PENTO_Y,c.PENTO_V,c.SNAKE_5,c.SNAKE_6,c.DOORFRAME_7]),h(W,"toxicToken",0),h(W,"toxicCooldownRemaining",0);const D={EASY:{heightWeight:-.3,linesWeight:.5,holesWeight:-.5,bumpinessWeight:-.2,randomFactor:.3},NORMAL:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,randomFactor:0},HARD:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,lookahead:1},GOD:{heightWeight:-.6,linesWeight:2.5,holesWeight:-.9,wellsWeight:-.25,bumpinessWeight:-.22,lexicographic:!0,preferEdges:!0}};class ft{constructor(){h(this,"traceEnabled",!1);h(this,"traceTopK",12);h(this,"lastTrace",null)}setTraceEnabled(t,e=12){this.traceEnabled=t,this.traceTopK=Math.max(1,Math.min(50,Math.floor(e))),t||(this.lastTrace=null)}getLastTrace(){return this.lastTrace}findBestMove(t,e,i){let s=-1/0,a=null,r=null;const l=this.traceEnabled?[]:[],u=t.getSpawnY(),o=this.computeHoleMap(t);for(let d=0;d<4;d++){const p=e.clone();p.setRotation(d);const f=p.getBlocks(),{minX:m,maxX:L}=this.getBlockXSpan(f),b=-m,M=S.WIDTH-1-L;for(let w=b;w<=M;w++){let O=-1;for(let P=u;P<S.TOTAL_ROWS&&t.isValidPosition(f,w,P,{ignoreCeiling:!0});P++)O=P;if(O===-1)continue;const E=this.computeEdgeDistance(f,w),y=this.evaluateMove(t,o,f,w,O,e.type,i);let A=y.score;if(i.randomFactor&&i.randomFactor>0){const P=(Math.random()-.5)*i.randomFactor*50;A+=P}const V={gameOverAfterMove:y.gameOverAfterMove,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,wellSums:y.wellSums,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,bumpiness:y.bumpiness,edgeDistance:E};(i.lexicographic?this.isBetterLexicographic(V,a,!!i.preferEdges):A>s)&&(a=V,s=A,r={x:w,rotation:d,score:A,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,maxHeight:y.maxHeight,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,bumpiness:y.bumpiness,gameOverAfterMove:y.gameOverAfterMove,edgeDistance:E,wellSums:y.wellSums}),this.traceEnabled&&l.push({x:w,rotation:d,y:O,score:A,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,maxHeight:y.maxHeight,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,bumpiness:y.bumpiness,gameOverAfterMove:y.gameOverAfterMove,edgeDistance:E,wellSums:y.wellSums})}}if(this.traceEnabled){const d=[...l].sort((b,M)=>this.compareCandidates(b,M,i)),p=d[0],f=d[1],m=i.lexicographic?["topOut","netBenefit","linesCleared","holes","blockades","wellSums","aggregateHeight","bumpiness",...i.preferEdges?["edgeDistance"]:[],"score"]:["score"],L=p&&f?this.getDecisionReason(p,f,i):void 0;p?this.lastTrace={pieceType:e.type,difficultyFlags:{lexicographic:!!i.lexicographic,preferEdges:!!i.preferEdges},weights:i,best:{...p,netBenefit:p.linesCleared*6-p.holesCreated},top:d.slice(0,this.traceTopK).map(b=>({...b,netBenefit:b.linesCleared*6-b.holesCreated})),totalCandidates:l.length,decisionOrder:m,decidedBy:L}:this.lastTrace=null}return r||{x:4,rotation:0,score:-1e6,linesCleared:0,aggregateHeight:0,maxHeight:22,holes:0,holesCreated:0,blockades:0,bumpiness:0,gameOverAfterMove:!0,edgeDistance:0,wellSums:0}}compareCandidates(t,e,i){if(!i.lexicographic)return e.score-t.score;if(t.gameOverAfterMove!==e.gameOverAfterMove)return t.gameOverAfterMove?1:-1;const s=t.linesCleared*6-t.holesCreated,a=e.linesCleared*6-e.holesCreated;return s!==a?a-s:t.maxHeight!==e.maxHeight?t.maxHeight-e.maxHeight:t.bumpiness!==e.bumpiness?t.bumpiness-e.bumpiness:t.linesCleared!==e.linesCleared?e.linesCleared-t.linesCleared:t.holes!==e.holes?t.holes-e.holes:t.blockades!==e.blockades?t.blockades-e.blockades:t.wellSums!==e.wellSums?t.wellSums-e.wellSums:t.aggregateHeight!==e.aggregateHeight?t.aggregateHeight-e.aggregateHeight:t.bumpiness!==e.bumpiness?t.bumpiness-e.bumpiness:i.preferEdges&&t.edgeDistance!==e.edgeDistance?t.edgeDistance-e.edgeDistance:e.score-t.score}getDecisionReason(t,e,i){if(!i.lexicographic)return t.score!==e.score?{key:"score",best:t.score,second:e.score}:void 0;if(t.gameOverAfterMove!==e.gameOverAfterMove)return{key:"topOut",best:t.gameOverAfterMove,second:e.gameOverAfterMove};const s=t.linesCleared*6-t.holesCreated,a=e.linesCleared*6-e.holesCreated;if(s!==a)return{key:"netBenefit",best:s,second:a};if(t.maxHeight!==e.maxHeight)return{key:"maxHeight",best:t.maxHeight,second:e.maxHeight};if(t.bumpiness!==e.bumpiness)return{key:"bumpiness",best:t.bumpiness,second:e.bumpiness};if(t.linesCleared!==e.linesCleared)return{key:"linesCleared",best:t.linesCleared,second:e.linesCleared};if(t.holes!==e.holes)return{key:"holes",best:t.holes,second:e.holes};if(t.holesCreated!==e.holesCreated)return{key:"holesCreated",best:t.holesCreated,second:e.holesCreated};if(t.wellSums!==e.wellSums)return{key:"wellSums",best:t.wellSums,second:e.wellSums};if(t.aggregateHeight!==e.aggregateHeight)return{key:"aggregateHeight",best:t.aggregateHeight,second:e.aggregateHeight};if(i.preferEdges&&t.edgeDistance!==e.edgeDistance)return{key:"edgeDistance",best:t.edgeDistance,second:e.edgeDistance};if(t.score!==e.score)return{key:"score",best:t.score,second:e.score}}isBetterLexicographic(t,e,i){if(!e)return!0;if(t.gameOverAfterMove!==e.gameOverAfterMove)return t.gameOverAfterMove===!1;const s=t.linesCleared*6-t.holesCreated,a=e.linesCleared*6-e.holesCreated;return s!==a?s>a:t.maxHeight!==e.maxHeight?t.maxHeight<e.maxHeight:t.bumpiness!==e.bumpiness?t.bumpiness<e.bumpiness:t.linesCleared!==e.linesCleared?t.linesCleared>e.linesCleared:t.holes!==e.holes?t.holes<e.holes:t.wellSums!==e.wellSums?t.wellSums<e.wellSums:t.aggregateHeight!==e.aggregateHeight?t.aggregateHeight<e.aggregateHeight:i&&t.edgeDistance!==e.edgeDistance?t.edgeDistance<e.edgeDistance:!1}computeEdgeDistance(t,e){let i=1/0;for(const s of t){const a=e+s.x,r=Math.min(a,S.WIDTH-1-a);r<i&&(i=r)}return i===1/0?0:i}evaluateMove(t,e,i,s,a,r,l){const u=t.clone(),o=Z[r]||1;u.lockPiece(i,s,a,o);const d=u.clearLines(),p=u.getAggregateHeight(),f=u.getHeight(),m=u.getWellSums(),L=u.countHoles(),b=this.computeHoleMap(u),M=this.countNewHoles(e,b),w=u.countBlockades(),O=u.getBumpiness(),E=u.isGameOver();let y=0;return E&&(y-=1e6),f>10&&(y-=Math.pow(f-10,2)*5),y+=p*l.heightWeight,y+=d*l.linesWeight,y+=L*l.holesWeight,y+=O*l.bumpinessWeight,{score:y,linesCleared:d,aggregateHeight:p,maxHeight:f,holes:L,holesCreated:M,blockades:w,wellSums:m,bumpiness:O,gameOverAfterMove:E}}computeHoleMap(t){const e=Array.from({length:S.TOTAL_ROWS},()=>Array(S.WIDTH).fill(!1));for(let i=0;i<S.WIDTH;i++){let s=!1;for(let a=0;a<S.TOTAL_ROWS;a++)t.data[a][i]!==0?s=!0:s&&(e[a][i]=!0)}return e}countNewHoles(t,e){let i=0;for(let s=0;s<S.TOTAL_ROWS;s++)for(let a=0;a<S.WIDTH;a++)e[s][a]&&!t[s][a]&&i++;return i}getBlockXSpan(t){let e=1/0,i=-1/0;for(const s of t)s.x<e&&(e=s.x),s.x>i&&(i=s.x);return e===1/0||i===-1/0?{minX:0,maxX:0}:{minX:e,maxX:i}}}class k{static defaultProfile(){return{totalScore:0,totalLinesCleared:0,totalPiecesPlaced:0,highestLevelCompleted:0,achievements:[],levelStats:{}}}static loadProfile(){try{const t=localStorage.getItem(this.KEY);if(!t)return this.defaultProfile();const e=JSON.parse(t);return{...this.defaultProfile(),...e}}catch(t){return console.error("Failed to load player profile",t),this.defaultProfile()}}static saveProfile(t){try{localStorage.setItem(this.KEY,JSON.stringify(t))}catch(e){console.error("Failed to save player profile",e)}}static updateStats(t,e,i,s,a,r){const l=this.loadProfile();l.totalScore+=e,l.totalLinesCleared+=i,l.totalPiecesPlaced+=s;const u=l.levelStats[t]||{highScore:0,bestDifficulty:"easy",completed:!1};return e>u.highScore&&(u.highScore=e),r&&(u.completed=!0,t>l.highestLevelCompleted&&(l.highestLevelCompleted=t),a==="god"&&!l.achievements.includes("GOD_SLAYER")&&l.achievements.push("GOD_SLAYER")),u.bestDifficulty=this.compareDifficulty(u.bestDifficulty,a),l.levelStats[t]=u,this.checkGlobalAchievements(l),this.saveProfile(l),l}static compareDifficulty(t,e){const i={easy:1,normal:2,hard:3,god:4};return i[e]>i[t]?e:t}static checkGlobalAchievements(t){const e=(i,s)=>{s&&!t.achievements.includes(i)&&t.achievements.push(i)};e("NOVICE_FEEDER",t.totalPiecesPlaced>=100),e("BLOCK_MASTER",t.totalPiecesPlaced>=1e3),e("LINE_CRUSHER",t.totalLinesCleared>=100),e("SCORE_MILLIONAIRE",t.totalScore>=1e5)}}h(k,"KEY","reversetetris_player_profile");const mt={easy:D.EASY,normal:D.NORMAL,hard:D.HARD,god:{...D.GOD,lookahead:2}};class Y{static generateLevel(t){let e="easy",i=800,s,a=3,r=Math.max(30,50-(t-1));t<=10?(e="easy",i=800-t*20):t<=25?(e="normal",i=600-(t-10)*15):t<=50?(e="hard",i=400-(t-25)*8):(e="god",i=200);const l=Math.max(0,6-Math.ceil(t/5));return l>0&&(s=this.generateGarbageGrid(l)),{id:t,name:`Level ${t}`,targetLines:r,aiDifficultyLevel:e,aiWeights:mt[e],aiSpeed:Math.max(100,i),initialGrid:s,pieceChoices:a}}static generateGarbageGrid(t){const e=Array.from({length:S.TOTAL_ROWS},()=>Array(S.WIDTH).fill(0)),i=S.TOTAL_ROWS-t;for(let s=i;s<S.TOTAL_ROWS;s++){for(let r=0;r<S.WIDTH;r++)if(Math.random()>.3){const l=Math.floor(Math.random()*7)+1;e[s][r]=l}const a=Math.floor(Math.random()*S.WIDTH);e[s][a]=0}return e}}var G=(n=>(n[n.MENU=0]="MENU",n[n.SELECTING=1]="SELECTING",n[n.AI_PLAYING=2]="AI_PLAYING",n[n.AI_ANIMATING=3]="AI_ANIMATING",n[n.PAUSED=4]="PAUSED",n[n.WIN=5]="WIN",n[n.LOSE=6]="LOSE",n))(G||{});class pt{constructor(t){h(this,"state",0);h(this,"grid");h(this,"renderer");h(this,"ai");h(this,"data");h(this,"currentPiece",null);h(this,"nextPieces",[]);h(this,"activePiecePosition",{x:0,y:0});h(this,"ghostPiecePosition",{x:0,y:0});h(this,"debugHudEnabled",!1);h(this,"versionHudEnabled",!0);h(this,"appVersion","");h(this,"difficultyOverride",null);h(this,"decisionLogVisible",!1);h(this,"lastDecisionLogText","");h(this,"aiTimer",0);h(this,"currentAiSpeed",500);h(this,"moveQueue",[]);h(this,"animationTimer",0);h(this,"lastAiMove",null);h(this,"listeners",{});this.renderer=t,this.grid=new S,this.ai=new ft,this.ai.setTraceEnabled(!0,12),this.data={level:1,linesCleared:0,piecesPlaced:0,targetLines:10,aiDifficulty:D.NORMAL,aiDifficultyLevel:"normal"}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}setDifficulty(t){this.data.aiDifficulty=D[t],this.data.aiDifficultyLevel=t.toLowerCase();let e=500;switch(t){case"EASY":this.currentAiSpeed=800,e=800;break;case"NORMAL":this.currentAiSpeed=500,e=500;break;case"HARD":this.currentAiSpeed=300,e=300;break;case"GOD":this.currentAiSpeed=200,e=200;break}this.difficultyOverride={level:this.data.aiDifficultyLevel,weights:this.data.aiDifficulty,speedMs:e}}start(t){t?this.loadLevel(t):this.loadLevel(Y.generateLevel(1))}loadLevel(t){this.data.level=t.id,this.data.targetLines=t.targetLines,this.difficultyOverride?(this.data.aiDifficulty=this.difficultyOverride.weights,this.data.aiDifficultyLevel=this.difficultyOverride.level,this.currentAiSpeed=this.difficultyOverride.speedMs):(this.data.aiDifficulty=t.aiWeights,this.data.aiDifficultyLevel=t.aiDifficultyLevel,this.currentAiSpeed=t.aiSpeed),this.grid=new S(t.initialGrid),this.data.linesCleared=0,this.data.piecesPlaced=0,this.state=1,this.startTurn(),this.emit("levelLoaded",t)}startTurn(){this.nextPieces=W.createRandomSet(3,{specialChance:this.getSpecialChanceForDifficulty()}),this.state=1,this.emit("stateChange",this.state),this.emit("nextPieces",this.nextPieces)}getSpecialChanceForDifficulty(){switch(this.data.aiDifficultyLevel){case"easy":return .1;case"normal":return .08;case"hard":return .06;case"god":return .04;default:return .01}}getCeilingDropInterval(){switch(this.data.aiDifficultyLevel){case"easy":return 5;case"normal":return 8;case"hard":return 12;case"god":return 15;default:return 10}}selectPiece(t){this.state===1&&(t<0||t>=this.nextPieces.length||(this.currentPiece=this.nextPieces[t],this.activePiecePosition={x:4,y:this.grid.getSpawnY()},this.emit("pieceSelected",this.currentPiece),this.state=2,this.aiTimer=0,this.prepareAIMove()))}prepareAIMove(){if(!this.currentPiece)return;const t=this.ai.findBestMove(this.grid,this.currentPiece,this.data.aiDifficulty);t&&(this.lastAiMove=t,this.updateDecisionLog(),this.generateMoveQueue(t),this.state=3,this.animationTimer=0)}updateDecisionLog(){const t=this.ai.getLastTrace();this.lastDecisionLogText=this.formatDecisionLog(t),this.decisionLogVisible&&this.emit("aiTrace",this.lastDecisionLogText)}formatDecisionLog(t){var f;const i=["ReverseTetris AI Trace",`time = ${new Date().toISOString()} `,`version = ${this.appVersion||"unknown"} `,`difficulty = ${this.data.aiDifficultyLevel} `,`turn = ${this.data.piecesPlaced+1} `].join(`
`),s=JSON.stringify(this.grid.data);if(!t){const m=this.currentPiece?this.currentPiece.type:"(none)",L=((f=this.nextPieces)==null?void 0:f.map(b=>b.type).join(","))??"";return`${i} 
currentPiece = ${m} 
nextPieces = [${L}]

(no trace available) 

grid = ${s} 
`}const a=`lexicographic = ${t.difficultyFlags.lexicographic} preferEdges = ${t.difficultyFlags.preferEdges} `,r=JSON.stringify(t.weights),l=t.decidedBy?`decidedBy = ${t.decidedBy.key} best = ${t.decidedBy.best} second = ${t.decidedBy.second} `:"decidedBy = (tie)",u=`order = ${t.decisionOrder.join(" > ")} `,o=m=>`x = ${m.x} r = ${m.rotation} y = ${m.y} H = ${m.holes} (+${m.holesCreated}) B = ${m.blockades} W = ${m.wellSums} L = ${m.linesCleared} MH = ${m.maxHeight} AH = ${m.aggregateHeight} BU = ${m.bumpiness} E = ${m.edgeDistance} S = ${Math.round(m.score*100)/100} `+(m.gameOverAfterMove?" TOP_OUT":""),d=`best: ${t.pieceType} ${o(t.best)} `,p=t.top.map((m,L)=>`${L+1}. ${t.pieceType} ${o(m)} `).join(`
`);return`${i} 
${a} 
${u} 
${l} 
weights = ${r} 

${d} 

top(${t.top.length} / ${t.totalCandidates}): 
${p} 

grid = ${s} 
`}generateMoveQueue(t){this.moveQueue=[];let e=t.rotation;for(let a=0;a<e;a++)this.moveQueue.push({type:"rotate",value:1});const s=t.x-4;if(s!==0){const a=s>0?1:-1;for(let r=0;r<Math.abs(s);r++)this.moveQueue.push({type:"move",value:a})}this.moveQueue.push({type:"drop",value:0})}update(t){if(this.state===2&&(this.aiTimer+=t,this.aiTimer>200&&this.prepareAIMove()),this.state===3&&this.currentPiece){this.animationTimer+=t;const e=this.moveQueue.length||1,i=Math.max(30,Math.min(200,this.currentAiSpeed/e));this.animationTimer>=i&&(this.animationTimer=0,this.processAnimationStep())}}processAnimationStep(){var e;if(this.moveQueue.length===0)return;const t=this.moveQueue.shift();t&&(t.type==="rotate"?(e=this.currentPiece)==null||e.rotateClockwise():t.type==="move"?this.activePiecePosition.x+=t.value:t.type==="drop"&&this.executeDropAndLock())}executeDropAndLock(){if(!this.currentPiece)return;const t=this.currentPiece.getBlocks(),e=this.grid.getSpawnY();let i=e,s=!1;for(let u=e;u<S.TOTAL_ROWS&&this.grid.isValidPosition(t,this.activePiecePosition.x,u,{ignoreCeiling:!0});u++)i=u,s=!0;if(!s){this.state=5,k.updateStats(this.data.level,this.data.linesCleared*100,this.data.linesCleared,this.data.piecesPlaced,this.data.aiDifficultyLevel,!0),this.emit("gameOver","win");return}this.activePiecePosition.y=i;const a=Z[this.currentPiece.type];if(this.grid.lockPiece(t,this.activePiecePosition.x,i,a),this.data.piecesPlaced++,this.grid.isPieceTouchingCeiling(t,this.activePiecePosition.x,i)){this.state=5,k.updateStats(this.data.level,this.data.linesCleared*100,this.data.linesCleared,this.data.piecesPlaced,this.data.aiDifficultyLevel,!0),this.emit("pieceLocked"),this.emit("gameOver","win");return}const r=this.grid.clearLines();r>0&&(this.data.linesCleared+=r,this.emit("linesCleared",r));const l=this.getCeilingDropInterval();if(l>0&&this.data.piecesPlaced>0&&this.data.piecesPlaced%l===0&&(this.grid.lowerCeiling(1),this.grid.isGameOver())){this.state=5,k.updateStats(this.data.level,this.data.linesCleared*100,this.data.linesCleared,this.data.piecesPlaced,this.data.aiDifficultyLevel,!0),this.emit("gameOver","win");return}this.emit("pieceLocked"),this.checkGameStatus(),this.state!==5&&this.state!==6&&this.state===3&&this.startTurn()}checkGameStatus(){if(this.data.linesCleared>=this.data.targetLines){this.state=6,k.updateStats(this.data.level,this.data.linesCleared*100,this.data.linesCleared,this.data.piecesPlaced,this.data.aiDifficultyLevel,!1),this.emit("gameOver","lose");return}if(this.grid.isGameOver()){this.state=5,k.updateStats(this.data.level,this.data.linesCleared*100,this.data.linesCleared,this.data.piecesPlaced,this.data.aiDifficultyLevel,!0),this.emit("gameOver","win");return}}render(){var t;if(this.renderer.clear(),this.renderer.drawGrid(this.grid),this.renderer.drawUI(this.data.linesCleared*100,this.data.level,this.data.linesCleared,this.data.targetLines,this.data.piecesPlaced,this.data.aiDifficultyLevel,this.debugHudEnabled?{wellSums:this.grid.getWellSums(),holes:this.grid.countHoles(),blockades:this.grid.countBlockades(),holesCreated:((t=this.lastAiMove)==null?void 0:t.holesCreated)??0,lastMove:this.lastAiMove?{holes:this.lastAiMove.holes,holesCreated:this.lastAiMove.holesCreated,blockades:this.lastAiMove.blockades,wellSums:this.lastAiMove.wellSums,linesCleared:this.lastAiMove.linesCleared,score:this.lastAiMove.score}:void 0}:void 0,this.versionHudEnabled?this.appVersion:void 0),this.state===1)this.renderer.drawPieceSelector(this.nextPieces,-1);else if((this.state===2||this.state===3)&&this.currentPiece){this.renderer.drawPiece(this.currentPiece,this.activePiecePosition.x,this.activePiecePosition.y);const e=this.currentPiece.getBlocks();let i=-1;for(let s=0;s<S.TOTAL_ROWS&&this.grid.isValidPosition(e,this.activePiecePosition.x,s);s++)i=s;i!==-1&&this.renderer.drawGhostPiece(this.currentPiece,this.activePiecePosition.x,i)}}toggleDebugHud(){this.debugHudEnabled=!this.debugHudEnabled}toggleVersionHud(){this.versionHudEnabled=!this.versionHudEnabled}setDecisionLogVisible(t){this.decisionLogVisible=t,t&&this.emit("aiTrace",this.lastDecisionLogText)}getLastDecisionLog(){return this.lastDecisionLogText}}class yt{constructor(t,e){h(this,"canvas");h(this,"renderer");h(this,"listeners",{});this.canvas=t,this.renderer=e,this.setupKeyboardListeners(),this.setupMouseListeners(),this.setupTouchListeners()}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(i=>i(e))}setupKeyboardListeners(){window.addEventListener("keydown",t=>{switch(t.key){case"1":this.emit("selectPiece",0);break;case"2":this.emit("selectPiece",1);break;case"3":this.emit("selectPiece",2);break;case"4":this.emit("selectPiece",3);break;case"p":case"P":this.emit("pause");break;case"r":case"R":this.emit("restart");break;case"Escape":this.emit("menu");break;case"d":case"D":this.emit("toggleDebug");break;case"v":case"V":this.emit("toggleVersion");break;case"s":case"S":this.emit("toggleAiLog");break}})}getScaledCoordinates(t,e){const i=this.canvas.getBoundingClientRect();return{x:t-i.left,y:e-i.top}}setupMouseListeners(){this.canvas.addEventListener("mousedown",t=>{const e=this.getScaledCoordinates(t.clientX,t.clientY);this.handlePointerDown(e.x,e.y)}),this.canvas.addEventListener("mousemove",t=>{const e=this.getScaledCoordinates(t.clientX,t.clientY);this.handlePointerMove(e.x,e.y)})}setupTouchListeners(){this.canvas.addEventListener("touchstart",t=>{t.preventDefault();const e=t.touches[0],i=this.getScaledCoordinates(e.clientX,e.clientY);this.handlePointerDown(i.x,i.y)},{passive:!1})}handlePointerDown(t,e){const i=this.renderer.layout;if(console.log("Click:",{x:t,y:e}),console.log("Layout:",{selectionX:i.selectionX,selectionY:i.selectionY,selectionHeight:i.selectionHeight,gridWidth:i.gridWidth,slotWidth:i.slotWidth}),e>=i.selectionY&&e<=i.selectionY+i.selectionHeight&&t>=i.selectionX&&t<=i.selectionX+i.gridWidth){const s=Math.floor((t-i.selectionX)/i.slotWidth);console.log("Hit selection! Index:",s),s>=0&&s<3&&this.emit("selectPiece",s)}}handlePointerMove(t,e){const i=this.renderer.layout;if(e>=i.selectionY&&e<=i.selectionY+i.selectionHeight&&t>=i.selectionX&&t<=i.selectionX+i.gridWidth){const s=Math.floor((t-i.selectionX)/i.slotWidth);if(s>=0&&s<3){this.emit("hoverPiece",s);return}}this.emit("hoverPiece",-1)}}class vt{constructor(){h(this,"ctx",null);h(this,"masterGain",null);h(this,"sfxGain",null);h(this,"bgmGain",null);h(this,"isMuted",!1);h(this,"volMaster",.5);h(this,"volSfx",.8);h(this,"volBgm",.4);h(this,"isPlayingBgm",!1);h(this,"bgmNodes",[]);h(this,"bgmTimeout",null)}async init(){if(!this.ctx)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.sfxGain=this.ctx.createGain(),this.bgmGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.sfxGain.connect(this.masterGain),this.bgmGain.connect(this.masterGain),this.updateVolumes()}catch(t){console.error("Audio init failed",t)}}updateVolumes(){if(!this.masterGain||!this.sfxGain||!this.bgmGain||!this.ctx)return;const t=this.ctx.currentTime;this.masterGain.gain.setValueAtTime(this.isMuted?0:this.volMaster,t),this.sfxGain.gain.setValueAtTime(this.volSfx,t),this.bgmGain.gain.setValueAtTime(this.volBgm,t)}setMute(t){this.isMuted=t,this.updateVolumes()}playSelect(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="square",t.frequency.setValueAtTime(440,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(880,this.ctx.currentTime+.1),e.gain.setValueAtTime(.1,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.sfxGain),t.start(),t.stop(this.ctx.currentTime+.1)}playDrop(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(150,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.15),e.gain.setValueAtTime(.3,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),t.connect(e),e.connect(this.sfxGain),t.start(),t.stop(this.ctx.currentTime+.2)}playClear(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.currentTime;[523.25,659.25,783.99,1046.5].forEach((i,s)=>{if(!this.ctx)return;const a=this.ctx.createOscillator(),r=this.ctx.createGain();a.type="square",a.frequency.setValueAtTime(i,t+s*.05),r.gain.setValueAtTime(.1,t+s*.05),r.gain.exponentialRampToValueAtTime(.01,t+s*.05+.1),a.connect(r),this.sfxGain&&r.connect(this.sfxGain),a.start(t+s*.05),a.stop(t+s*.05+.1)})}playGameOver(t){if(!(!this.ctx||!this.sfxGain))if(t)this.playClear();else{const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.type="sawtooth",e.frequency.setValueAtTime(200,this.ctx.currentTime),e.frequency.linearRampToValueAtTime(50,this.ctx.currentTime+.5),i.gain.setValueAtTime(.2,this.ctx.currentTime),i.gain.linearRampToValueAtTime(.01,this.ctx.currentTime+.5),e.connect(i),i.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.5)}}toggleBgm(){this.isMuted?(this.setMute(!1),this.isPlayingBgm||this.startBgm()):this.setMute(!0)}isBgmPlaying(){return!this.isMuted}startBgm(){this.ctx&&(this.isPlayingBgm||(this.isPlayingBgm=!0,this.playBGMLoop()))}playBGMLoop(){if(!this.isPlayingBgm||!this.ctx||!this.bgmGain)return;const e=60/128,i=this.ctx.currentTime;[220,277,330].forEach(l=>{if(!this.ctx||!this.bgmGain)return;const u=this.ctx.createOscillator(),o=this.ctx.createGain();u.type="triangle",u.frequency.value=l,o.gain.setValueAtTime(.05,i),o.gain.linearRampToValueAtTime(.05,i+e*7),o.gain.linearRampToValueAtTime(0,i+e*8),u.connect(o),o.connect(this.bgmGain),u.start(i),u.stop(i+e*8),this.bgmNodes.push({osc:u,gain:o})}),[440,523,659,784,659,523,440,392].forEach((l,u)=>{if(!this.ctx||!this.bgmGain)return;const o=this.ctx.createOscillator(),d=this.ctx.createGain();o.type="sine",o.frequency.value=l;const p=i+u*e;d.gain.setValueAtTime(0,p),d.gain.linearRampToValueAtTime(.1,p+.01),d.gain.exponentialRampToValueAtTime(.01,p+e*.5),o.connect(d),d.connect(this.bgmGain),o.start(p),o.stop(p+e*.6),this.bgmNodes.push({osc:o,gain:d})});const r=e*8*1e3;this.bgmNodes=[],this.bgmTimeout=window.setTimeout(()=>{this.isPlayingBgm&&this.playBGMLoop()},r-50)}stopBgm(){this.isPlayingBgm=!1,this.bgmTimeout!==null&&(clearTimeout(this.bgmTimeout),this.bgmTimeout=null),this.bgmNodes.forEach(t=>{try{t.osc.stop(),t.osc.disconnect(),t.gain.disconnect()}catch{}}),this.bgmNodes=[]}}class xt{constructor(){h(this,"overlays",{});h(this,"app");h(this,"aiLogPanel");h(this,"aiLogVisible",!1);h(this,"aiLogTextArea",null);this.app=document.getElementById("app"),this.createOverlays(),this.aiLogPanel=this.createAiLogPanel(),this.show("menu")}createOverlays(){this.overlays.menu=this.createOverlay("menu-overlay",`
            <h1 class="title">REVERSE TETRIS</h1>
            <div class="menu-buttons">
                <button id="btn-start" class="btn primary">START GAME</button>
                <button id="btn-levels" class="btn">LEVELS</button>
                <button id="btn-stats" class="btn">STATS</button>
                <button id="btn-howto" class="btn">HOW TO PLAY</button>
                <button id="btn-settings" class="btn">SETTINGS</button>
            </div>
            <p class="footer">Feed the AI until it bursts.</p>
        `),this.overlays.howto=this.createOverlay("howto-overlay",`
            <h2>游戏说明</h2>
            <div class="howto-content">
                <p><strong>目标：</strong>让电脑 AI 的方块堆叠并触碰到下落的<strong>天花板红线</strong>，使其"顶飞"（Top Out）。</p>
                <p><strong>核心规则：</strong></p>
                <ul>
                    <li>每回合从 3 个候选方块中选择 1 个分发给 AI。</li>
                    <li><strong>动态天花板：</strong>红线会随时间不断下降，压缩 AI 的生存空间。</li>
                    <li><strong>玩家获胜：</strong>AI 放置方块后，只要方块任何部分触碰或越过红线，你就赢了。</li>
                    <li><strong>玩家失败：</strong>AI 在触顶前消除的行数达到关卡目标。</li>
                </ul>
                <p><strong>技巧：</strong>长条(I)会帮 AI 消行续命，尽量喂给它 S/Z/T 或特殊的金块形状来干扰它！</p>
            </div>
            <button id="btn-back-howto" class="btn">BACK</button>
        `),this.overlays.settings=this.createOverlay("settings-overlay",`
            <h2>设置</h2>
            <div class="settings-content">
                <div class="setting-item">
                    <label>电脑难度</label>
                    <div class="difficulty-btns">
                        <button id="diff-easy" class="btn diff-btn">简单</button>
                        <button id="diff-normal" class="btn diff-btn active">普通</button>
                        <button id="diff-hard" class="btn diff-btn">困难</button>
                        <button id="diff-god" class="btn diff-btn">地狱</button>
                    </div>
                </div>
            </div>
            <button id="btn-back-settings" class="btn">BACK</button>
        `),this.overlays.stats=this.createOverlay("stats-overlay",`
            <h2>PLAYER RECORDS</h2>
            <div class="stats-content" id="stats-container">
                <!-- Content generated on fly -->
            </div>
            <button id="btn-back-stats" class="btn">BACK</button>
        `),this.overlays.levels=this.createOverlay("levels-overlay",`
            <h2>SELECT LEVEL</h2>
            <div class="level-grid" id="level-grid">
                <!-- Generated via JS -->
            </div>
            <button id="btn-back-levels" class="btn back">BACK</button>
        `),this.overlays.pause=this.createOverlay("pause-overlay",`
            <h2>PAUSED</h2>
            <button id="btn-resume" class="btn primary">RESUME</button>
            <button id="btn-restart-pause" class="btn">RESTART</button>
            <button id="btn-menu-pause" class="btn">MAIN MENU</button>
        `),this.overlays.win=this.createOverlay("win-overlay",`
            <h1 class="win">VICTORY!</h1>
            <p>The AI Topped Out.</p>
            <p id="win-stats" class="result-stats"></p>
            <button id="btn-next-level" class="btn primary">NEXT LEVEL</button>
            <button id="btn-share-win" class="btn">SHARE</button>
            <button id="btn-menu-win" class="btn">MAIN MENU</button>
        `),this.overlays.lose=this.createOverlay("lose-overlay",`
            <h1 class="lose">DEFEAT</h1>
            <p>The AI Survived your attacks.</p>
            <p id="lose-stats" class="result-stats"></p>
            <button id="btn-retry" class="btn primary">RETRY</button>
            <button id="btn-share-lose" class="btn">SHARE</button>
            <button id="btn-menu-lose" class="btn">MAIN MENU</button>
        `);const t=document.createElement("div");t.id="hud-overlay",t.className="overlay hidden",t.style.pointerEvents="none",t.innerHTML=`
            <div class="hud-top">
                <div class="hud-score">Level: <span id="hud-level">1</span></div>
                <div class="hud-target">Target: <span id="hud-target">0</span>/10 Lines</div>
            </div>
        `,this.app.appendChild(t),this.overlays.hud=t}createAiLogPanel(){const t=document.createElement("div");t.id="ai-log-panel",t.className="ai-log-panel hidden",t.innerHTML=`
            <div class="ai-log-header">
                <div class="ai-log-title">AI LOG</div>
                <div class="ai-log-actions">
                    <button id="ai-log-copy" class="ai-log-btn">COPY</button>
                    <button id="ai-log-close" class="ai-log-btn">CLOSE</button>
                </div>
            </div>
            <textarea id="ai-log-text" class="ai-log-text" readonly></textarea>
            <div class="ai-log-hint">Toggle: S</div>
        `,this.app.appendChild(t),this.aiLogTextArea=t.querySelector("#ai-log-text");const e=t.querySelector("#ai-log-copy");e==null||e.addEventListener("click",async()=>{var a;const s=((a=this.aiLogTextArea)==null?void 0:a.value)??"";this.aiLogTextArea&&(this.aiLogTextArea.focus(),this.aiLogTextArea.select());try{await navigator.clipboard.writeText(s),e.textContent="COPIED",setTimeout(()=>e.textContent="COPY",800)}catch{this.aiLogTextArea&&(this.aiLogTextArea.focus(),this.aiLogTextArea.select())}});const i=t.querySelector("#ai-log-close");return i==null||i.addEventListener("click",()=>this.setAiLogVisible(!1)),t}createOverlay(t,e){const i=document.createElement("div");return i.id=t,i.className="overlay hidden",i.innerHTML=e,this.app.appendChild(i),i}show(t){Object.values(this.overlays).forEach(e=>e.classList.add("hidden")),this.overlays[t]&&this.overlays[t].classList.remove("hidden"),t==="game"&&this.overlays.hud.classList.remove("hidden")}hideAll(){Object.values(this.overlays).forEach(t=>t.classList.add("hidden"))}toggleAiLogPanel(){this.setAiLogVisible(!this.aiLogVisible)}setAiLogVisible(t){this.aiLogVisible=t,t?this.aiLogPanel.classList.remove("hidden"):this.aiLogPanel.classList.add("hidden")}isAiLogVisible(){return this.aiLogVisible}setAiLog(t){this.aiLogTextArea&&(this.aiLogTextArea.value=t,this.aiLogTextArea.scrollTop=this.aiLogTextArea.scrollHeight)}on(t,e,i){const s=document.getElementById(t);s&&s.addEventListener(e,i)}updateHUD(t,e,i){const s=document.getElementById("hud-level"),a=document.getElementById("hud-target");s&&(s.textContent=t.toString()),a&&(a.textContent=e.toString()+"/"+i.toString())}updateStatsContent(t){const e=document.getElementById("stats-container");if(!e)return;const i={GOD_SLAYER:"地狱终结者 (God Slayer)",NOVICE_FEEDER:"初级投喂员 (100 blocks)",BLOCK_MASTER:"方块大师 (1000 blocks)",LINE_CRUSHER:"拆迁队长 (100 lines)",SCORE_MILLIONAIRE:"百万富翁 (100k score)"};e.innerHTML=`
            <div class="stat-row"><span>Total Score:</span> <span>${t.totalScore.toLocaleString()}</span></div>
            <div class="stat-row"><span>Lines Cleared:</span> <span>${t.totalLinesCleared}</span></div>
            <div class="stat-row"><span>Blocks Fed:</span> <span>${t.totalPiecesPlaced}</span></div>
            <div class="stat-row"><span>Levels Completed:</span> <span>${t.highestLevelCompleted}</span></div>
            <div class="achievements-section">
                <h3>Achievements</h3>
                <div class="achievements-list">
                    ${t.achievements.length>0?t.achievements.map(s=>`<div class="achievement-tag">${i[s]||s}</div>`).join(""):'<div class="no-achievements">Keep playing to unlock!</div>'}
                </div>
            </div>
        `}generateLevelGrid(t,e,i){const s=document.getElementById("level-grid");if(s){s.innerHTML="";for(let a=1;a<=t;a++){const r=a>e+1,l=document.createElement("button");l.className=`level-btn ${r?"locked":""}`,l.innerHTML=r?`<span>${a}</span> <small>🔒</small>`:a.toString(),r||(l.onclick=()=>i(a)),s.appendChild(l)}}}}const J="reversetetris:dismissViewportWarning";function Tt(){var p;const n=()=>typeof navigator<"u"&&navigator.maxTouchPoints>0||typeof window<"u"&&"ontouchstart"in window,t=f=>{try{return localStorage.getItem(f)}catch{return null}},e=(f,m)=>{try{localStorage.setItem(f,m)}catch{}};if(!n()||t(J)==="1")return;let i=null,s=!1;const a=()=>{var O,E;const f=((O=window.visualViewport)==null?void 0:O.width)??window.innerWidth,m=window.innerWidth,L=((E=window.screen)==null?void 0:E.width)??f,b=f>0?m/f:1,M=Math.min(f,L)<=520,w=m>=900||b>=1.25;return M&&w},r=()=>i||(i=document.createElement("div"),i.className="viewport-warning",i.innerHTML=`
      <div class="viewport-warning__content" role="status" aria-live="polite">
        <div class="viewport-warning__text">
          检测到可能启用了「桌面版站点」或非 100% 缩放，布局可能异常。请关闭桌面版站点并把缩放调回 100%。
        </div>
        <div class="viewport-warning__actions">
          <button type="button" class="viewport-warning__btn" data-action="dismiss">关闭</button>
          <button type="button" class="viewport-warning__btn viewport-warning__btn--secondary" data-action="dontshow">不再提示</button>
        </div>
      </div>
    `,i.addEventListener("click",f=>{const m=f.target,L=m==null?void 0:m.closest("button[data-action]"),b=L==null?void 0:L.dataset.action;b&&(b==="dontshow"&&e(J,"1"),u())}),document.body.appendChild(i),i),l=()=>{const f=r();f.style.display="block",document.documentElement.style.setProperty("--viewport-warning-offset","56px")},u=()=>{i&&(i.style.display="none"),document.documentElement.style.removeProperty("--viewport-warning-offset")},o=()=>{s=!1,a()?l():u()},d=()=>{s||(s=!0,requestAnimationFrame(o))};window.addEventListener("resize",d),(p=window.visualViewport)==null||p.addEventListener("resize",d),d()}function St(n){const t=`${location.origin}${location.pathname}`,e=n.difficulty.length>0?n.difficulty[0].toUpperCase()+n.difficulty.slice(1):n.difficulty,a=["🎮🔥 **做了个反向 Tetris 小游戏！** ","玩家负责**选方块**，电脑负责**摆放**，主打一个——折磨电脑 🤖💥","",`🚀 **Reverse Tetris · 第 ${n.level} 关**`,n.result==="win"?"直接把电脑**顶飞**！":"差点把电脑顶飞…但它苟住了！",`🧱 用块数：**${n.piecesPlaced}**`,`🧠 电脑只消了：**${n.linesCleared} / ${n.targetLines} 行**`,`⚙️ 难度：**${e}**`,"","😤➡️😌 出了口气，整个人都神清气爽了！","","👉 **你也来试试暴打它解压吧：**",`🔗 ${t}  `,"🔗 复制到浏览器进行游戏","","⚠️ 温馨提醒：","","* 💀 **千万别手贱挑战「地狱电脑」**","* 📱 如果画面太小，记得在手机浏览器里**关闭「电脑模式」**","","来，看你能把电脑虐到第几关 😈🎉"].join(`
`);return{title:"Reverse Tetris",shareText:a,copyText:a,url:t}}async function tt(n){var e;const t=St(n);if(typeof navigator<"u"&&"share"in navigator)try{await navigator.share({title:t.title,text:t.shareText});return}catch{}try{if(!((e=navigator.clipboard)!=null&&e.writeText))throw new Error("Clipboard not available");await navigator.clipboard.writeText(t.copyText),alert("分享文案已复制，可以粘贴到微信/朋友圈/群聊。")}catch{prompt("复制分享文案（长按全选复制）",t.copyText)}}function Lt(n){return n===G.SELECTING||n===G.AI_PLAYING||n===G.AI_ANIMATING}const bt=document.querySelector("#app");bt.innerHTML=`
  <canvas id="game-canvas" width="800" height="600"></canvas>
  <button id="menu-btn" aria-label="Menu">☰</button>
  <button id="audio-btn">🔇</button>
`;Tt();const B=document.getElementById("game-canvas"),R=new gt(B),x=new pt(R);x.appVersion="v0.0.0+3f78642";const _=new yt(B,R),T=new vt,g=new xt,wt=document.getElementById("menu-btn"),et=()=>{Lt(x.state)&&(g.show("pause"),T.playSelect())};wt.addEventListener("click",n=>{n.stopPropagation(),et()});const N=()=>{T.init(),B.removeEventListener("mousedown",N),B.removeEventListener("touchstart",N),window.removeEventListener("keydown",N)};B.addEventListener("mousedown",N);B.addEventListener("touchstart",N);window.addEventListener("keydown",N);const U=document.getElementById("audio-btn");U.addEventListener("click",n=>{n.stopPropagation(),T.init(),T.toggleBgm(),T.isBgmPlaying()?U.textContent="🔊":U.textContent="🔇"});let H="NORMAL";g.on("btn-start","click",()=>{g.show("game"),x.setDifficulty(H),x.start(),T.playSelect()});g.on("btn-levels","click",()=>{const n=k.loadProfile();g.generateLevelGrid(20,n.highestLevelCompleted,t=>{g.show("game"),x.setDifficulty(H),x.loadLevel(Y.generateLevel(t)),T.playSelect()}),g.show("levels"),T.playSelect()});g.on("btn-stats","click",()=>{const n=k.loadProfile();g.updateStatsContent(n),g.show("stats"),T.playSelect()});g.on("btn-back-stats","click",()=>{g.show("menu"),T.playSelect()});g.on("btn-howto","click",()=>{g.show("howto"),T.playSelect()});g.on("btn-back-howto","click",()=>{g.show("menu"),T.playSelect()});g.on("btn-settings","click",()=>{g.show("settings"),T.playSelect()});g.on("btn-back-settings","click",()=>{g.show("menu"),T.playSelect()});const X=()=>{document.querySelectorAll(".diff-btn").forEach(t=>t.classList.remove("active"));const n=document.getElementById(`diff-${H.toLowerCase()}`);n&&n.classList.add("active")};g.on("diff-easy","click",()=>{H="EASY",X(),T.playSelect()});g.on("diff-normal","click",()=>{H="NORMAL",X(),T.playSelect()});g.on("diff-hard","click",()=>{H="HARD",X(),T.playSelect()});g.on("diff-god","click",()=>{H="GOD",X(),T.playSelect()});g.on("btn-back-levels","click",()=>{g.show("menu"),T.playSelect()});g.on("btn-resume","click",()=>{g.show("game"),T.playSelect()});g.on("btn-restart-pause","click",()=>{g.show("game"),x.start(Y.generateLevel(x.data.level)),T.playSelect()});g.on("btn-menu-pause","click",()=>{g.show("menu"),T.playSelect()});g.on("btn-next-level","click",()=>{const n=x.data.level;x.loadLevel(Y.generateLevel(n+1)),g.show("game"),T.playSelect()});g.on("btn-menu-win","click",()=>{g.show("menu"),T.playSelect()});g.on("btn-share-win","click",async()=>{T.playSelect(),C&&await tt(C)});g.on("btn-retry","click",()=>{x.loadLevel(Y.generateLevel(x.data.level)),g.show("game"),T.playSelect()});g.on("btn-share-lose","click",async()=>{T.playSelect(),C&&await tt(C)});g.on("btn-menu-lose","click",()=>{g.show("menu"),T.playSelect()});_.on("selectPiece",n=>{T.playSelect(),x.selectPiece(n)});_.on("restart",()=>{T.playSelect(),x.start(Y.generateLevel(x.data.level))});_.on("pause",()=>{g.show("pause"),T.playSelect()});_.on("menu",()=>{et()});_.on("toggleDebug",()=>{x.toggleDebugHud()});_.on("toggleVersion",()=>{x.toggleVersionHud()});_.on("toggleAiLog",()=>{g.toggleAiLogPanel(),x.setDecisionLogVisible(g.isAiLogVisible()),g.isAiLogVisible()&&g.setAiLog(x.getLastDecisionLog())});x.on("pieceLocked",()=>{T.playDrop(),R.animator.triggerShake(100)});x.on("linesCleared",n=>{T.playClear(),g.updateHUD(x.data.level,x.data.linesCleared,x.data.targetLines);const t=R.layout.gridX+R.layout.gridWidth/2,e=R.layout.gridY+R.layout.gridHeight/2;R.animator.spawnParticles(t,e,"#ffcc00",20*n),R.animator.spawnText(t,e,`+${n}`,"#fff"),R.animator.triggerShake(300)});x.on("levelLoaded",n=>{g.updateHUD(n.id,0,n.targetLines)});let C=null;x.on("gameOver",n=>{T.playGameOver(n==="win"),C={result:n,level:x.data.level,linesCleared:x.data.linesCleared,targetLines:x.data.targetLines,piecesPlaced:x.data.piecesPlaced,difficulty:x.data.aiDifficultyLevel};const t=n==="win"?`Blocks: ${C.piecesPlaced} • AI Lines: ${C.linesCleared}/${C.targetLines}`:`Blocks: ${C.piecesPlaced} • AI Lines: ${C.linesCleared}/${C.targetLines}`,e=document.getElementById(n==="win"?"win-stats":"lose-stats");e&&(e.textContent=t),n==="win"?g.show("win"):g.show("lose")});x.on("aiTrace",n=>{g.isAiLogVisible()&&g.setAiLog(n)});let j=0;function it(n){const t=n-j;j=n,x.update(t),x.render(),requestAnimationFrame(it)}requestAnimationFrame(it);
