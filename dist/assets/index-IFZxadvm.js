var k=Object.defineProperty;var C=(l,t,e)=>t in l?k(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var r=(l,t,e)=>C(l,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const d=class d{constructor(t){r(this,"_grid");t?this._grid=t.map(e=>[...e]):this._grid=Array.from({length:d.TOTAL_ROWS},()=>Array(d.WIDTH).fill(0))}get data(){return this._grid}isCellEmpty(t,e){return t<0||t>=d.WIDTH||e>=d.TOTAL_ROWS?!1:e<0?!0:this._grid[e][t]===0}isValidPosition(t,e,s){for(const i of t){const a=e+i.x,n=s+i.y;if(a<0||a>=d.WIDTH||n>=d.TOTAL_ROWS||n>=0&&this._grid[n][a]!==0)return!1}return!0}lockPiece(t,e,s,i){for(const a of t){const n=e+a.x,o=s+a.y;n>=0&&n<d.WIDTH&&o>=0&&o<d.TOTAL_ROWS&&(this._grid[o][n]=i)}}clearLines(){let t=0;for(let e=d.TOTAL_ROWS-1;e>=0;e--)this.isRowFull(e)&&(this.removeRow(e),t++,e++);return t}isRowFull(t){return this._grid[t].every(e=>e!==0)}removeRow(t){this._grid.splice(t,1),this._grid.unshift(Array(d.WIDTH).fill(0))}isGameOver(){return this._grid[0].some(t=>t!==0)||this._grid[1].some(t=>t!==0)}getHeight(){for(let t=0;t<d.TOTAL_ROWS;t++)if(this._grid[t].some(e=>e!==0))return d.TOTAL_ROWS-t;return 0}countHoles(){let t=0;for(let e=0;e<d.WIDTH;e++){let s=!1;for(let i=0;i<d.TOTAL_ROWS;i++)this._grid[i][e]!==0?s=!0:s&&this._grid[i][e]===0&&t++}return t}getAggregateHeight(){let t=0;for(let e=0;e<d.WIDTH;e++)for(let s=0;s<d.TOTAL_ROWS;s++)if(this._grid[s][e]!==0){t+=d.TOTAL_ROWS-s;break}return t}getBumpiness(){let t=0,e=this.getColumnHeight(0);for(let s=1;s<d.WIDTH;s++){const i=this.getColumnHeight(s);t+=Math.abs(e-i),e=i}return t}getColumnHeight(t){for(let e=0;e<d.TOTAL_ROWS;e++)if(this._grid[e][t]!==0)return d.TOTAL_ROWS-e;return 0}clone(){const t=new d;return t._grid=this._grid.map(e=>[...e]),t}};r(d,"WIDTH",10),r(d,"HEIGHT",20),r(d,"TOTAL_ROWS",22),r(d,"VISIBLE_ROWS",20);let g=d;var c=(l=>(l.I="I",l.O="O",l.T="T",l.S="S",l.Z="Z",l.J="J",l.L="L",l))(c||{});const G={[c.I]:[[[-1,0],[0,0],[1,0],[2,0]],[[1,-1],[1,0],[1,1],[1,2]],[[-1,1],[0,1],[1,1],[2,1]],[[0,-1],[0,0],[0,1],[0,2]]],[c.O]:[[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]]],[c.T]:[[[0,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[0,1]]],[c.S]:[[[0,-1],[1,-1],[-1,0],[0,0]],[[0,-1],[0,0],[1,0],[1,1]],[[0,0],[1,0],[-1,1],[0,1]],[[-1,-1],[-1,0],[0,0],[0,1]]],[c.Z]:[[[-1,-1],[0,-1],[0,0],[1,0]],[[1,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[0,1],[1,1]],[[0,-1],[-1,0],[0,0],[-1,1]]],[c.J]:[[[-1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[1,-1],[0,0],[0,1]],[[-1,0],[0,0],[1,0],[1,1]],[[0,-1],[0,0],[-1,1],[0,1]]],[c.L]:[[[1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[1,0],[-1,1]],[[-1,-1],[0,-1],[0,0],[0,1]]]},W={[c.I]:"#00f0f0",[c.O]:"#f0f000",[c.T]:"#a000f0",[c.S]:"#00f000",[c.Z]:"#f00000",[c.J]:"#0000f0",[c.L]:"#f0a000"},R={[c.I]:1,[c.O]:2,[c.T]:3,[c.S]:4,[c.Z]:5,[c.J]:6,[c.L]:7},M={1:"#00f0f0",2:"#f0f000",3:"#a000f0",4:"#00f000",5:"#f00000",6:"#0000f0",7:"#f0a000"};class F{constructor(){r(this,"particles",[]);r(this,"texts",[]);r(this,"shakeX",0);r(this,"shakeY",0);r(this,"shakeTime",0)}update(t){if(this.particles=this.particles.filter(e=>(e.x+=e.vx*(t/16),e.y+=e.vy*(t/16),e.life-=t,e.life>0)),this.texts=this.texts.filter(e=>(e.y+=e.vy*(t/16),e.life-=t,e.life>0)),this.shakeTime>0){this.shakeTime-=t;const e=Math.min(10,this.shakeTime/20);this.shakeX=(Math.random()-.5)*e,this.shakeY=(Math.random()-.5)*e}else this.shakeX=0,this.shakeY=0}draw(t){this.particles.forEach(e=>{t.globalAlpha=e.life/e.maxLife,t.fillStyle=e.color,t.fillRect(e.x,e.y,e.size,e.size)}),t.globalAlpha=1,this.texts.forEach(e=>{t.globalAlpha=e.life/e.maxLife,t.fillStyle=e.color,t.font="bold 20px Arial",t.fillText(e.text,e.x,e.y)}),t.globalAlpha=1}getShake(){return{x:this.shakeX,y:this.shakeY}}spawnParticles(t,e,s,i=10){for(let a=0;a<i;a++)this.particles.push({x:t,y:e,vx:(Math.random()-.5)*5,vy:(Math.random()-.5)*5,life:500+Math.random()*500,maxLife:1e3,color:s,size:2+Math.random()*3})}spawnText(t,e,s,i="#fff"){this.texts.push({x:t,y:e,text:s,color:i,life:1e3,maxLife:1e3,vy:-1})}triggerShake(t=200){this.shakeTime=t}}class H{constructor(t){r(this,"canvas");r(this,"ctx");r(this,"width");r(this,"height");r(this,"animator");r(this,"CELL_SIZE",30);r(this,"GRID_OFFSET_X",50);r(this,"GRID_OFFSET_Y",50);r(this,"VISIBLE_START_ROW",2);r(this,"GRID_WIDTH_PX",10*this.CELL_SIZE);r(this,"GRID_HEIGHT_PX",20*this.CELL_SIZE);r(this,"UI_OFFSET_X",400);r(this,"UI_OFFSET_Y",50);this.canvas=t,this.ctx=t.getContext("2d"),this.width=t.width,this.height=t.height,this.animator=new F,this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}handleResize(){const t=window.devicePixelRatio||1,e=800,s=600;this.canvas.width=e*t,this.canvas.height=s*t,this.ctx.scale(t,t),this.width=e,this.height=s}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.width,this.height),this.animator.draw(this.ctx)}update(t){this.animator.update(t)}drawAnimations(){this.animator.draw(this.ctx)}drawGrid(t){const e=this.animator.getShake();this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.strokeRect(this.GRID_OFFSET_X-2,this.GRID_OFFSET_Y-2,this.GRID_WIDTH_PX+4,this.GRID_HEIGHT_PX+4);const s=t.data;for(let i=this.VISIBLE_START_ROW;i<g.TOTAL_ROWS;i++)for(let a=0;a<g.WIDTH;a++){const n=s[i][a],o=M[n];n!==0&&o?this.drawCell(a,i,o):(this.ctx.strokeStyle="#2a2a2a",this.ctx.strokeRect(this.GRID_OFFSET_X+a*this.CELL_SIZE,this.GRID_OFFSET_Y+(i-this.VISIBLE_START_ROW)*this.CELL_SIZE,this.CELL_SIZE,this.CELL_SIZE))}this.ctx.restore()}drawPiece(t,e,s,i){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y);const n=t.getBlocks(i),o=t.getColor();for(const T of n){const m=e+T.x,p=s+T.y;p>=this.VISIBLE_START_ROW&&this.drawCell(m,p,o)}this.ctx.restore()}drawGhostPiece(t,e,s,i){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y),this.ctx.globalAlpha=.3;const n=t.getBlocks(i),o=t.getColor();for(const T of n){const m=e+T.x,p=s+T.y;p>=this.VISIBLE_START_ROW&&this.drawCell(m,p,o,!0)}this.ctx.globalAlpha=1,this.ctx.restore()}drawCell(t,e,s,i=!1){const a=this.GRID_OFFSET_X+t*this.CELL_SIZE,n=this.GRID_OFFSET_Y+(e-this.VISIBLE_START_ROW)*this.CELL_SIZE;this.ctx.fillStyle=s,this.ctx.fillRect(a+1,n+1,this.CELL_SIZE-2,this.CELL_SIZE-2),i||(this.ctx.fillStyle="rgba(255, 255, 255, 0.3)",this.ctx.fillRect(a+1,n+1,this.CELL_SIZE-2,4),this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.fillRect(a+1,n+this.CELL_SIZE-4-1,this.CELL_SIZE-2,4))}drawPieceSelector(t,e){this.ctx.fillStyle="#fff",this.ctx.font="20px Arial",this.ctx.fillText("Select Piece:",this.UI_OFFSET_X,this.UI_OFFSET_Y),this.ctx.font="14px Arial",this.ctx.fillText("(Press 1, 2, 3)",this.UI_OFFSET_X,this.UI_OFFSET_Y+25),t.forEach((s,i)=>{const a=i===e,n=this.UI_OFFSET_X,o=this.UI_OFFSET_Y+60+i*100;this.ctx.strokeStyle=a?"#ffcc00":"#444",this.ctx.lineWidth=a?3:1,this.ctx.strokeRect(n,o,100,80),a&&(this.ctx.fillStyle="rgba(255, 204, 0, 0.1)",this.ctx.fillRect(n,o,100,80)),this.ctx.fillStyle=a?"#ffcc00":"#888",this.ctx.font="16px Arial",this.ctx.fillText(`${i+1}`,n+5,o+20),this.drawMiniPiece(s,n+50,o+40)})}drawMiniPiece(t,e,s){const i=t.getBlocks(0),a=t.getColor(),n=20;for(const o of i){const T=e+o.x*n,m=s+o.y*n;this.ctx.fillStyle=a,this.ctx.fillRect(T,m,n-1,n-1)}}drawUI(t,e,s){const i=this.UI_OFFSET_X,a=400,n=30;this.ctx.fillStyle="#fff",this.ctx.font="20px Arial",this.ctx.fillText(`Score: ${t}`,i,a),this.ctx.fillText(`Level: ${e}`,i,a+n),this.ctx.fillText(`Lines: ${s}`,i,a+n*2)}drawText(t,e,s,i=30,a="#fff"){this.ctx.fillStyle=a,this.ctx.font=`${i}px Arial`,this.ctx.fillText(t,e,s)}}class w{constructor(t){r(this,"type");r(this,"_rotation");this.type=t,this._rotation=0}get rotation(){return this._rotation}rotateClockwise(){this._rotation=(this._rotation+1)%4}rotateCounterClockwise(){this._rotation=(this._rotation+3)%4}setRotation(t){this._rotation=t%4}getBlocks(t){const e=t!==void 0?t%4:this._rotation;return G[this.type][e].map(([a,n])=>({x:a,y:n}))}getColor(){return W[this.type]}clone(){const t=new w(this.type);return t.setRotation(this._rotation),t}}class O{static createRandom(){this.bag.length===0&&this.refillBag();const t=this.bag.pop();return new w(t)}static createRandomSet(t){const e=[];for(let s=0;s<t;s++)e.push(this.createRandom());return e}static refillBag(){this.bag=[...this.types];for(let t=this.bag.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[this.bag[t],this.bag[e]]=[this.bag[e],this.bag[t]]}}}r(O,"types",[c.I,c.O,c.T,c.S,c.Z,c.J,c.L]),r(O,"bag",[]);const b={EASY:{heightWeight:-.3,linesWeight:.5,holesWeight:-.5,bumpinessWeight:-.2,randomFactor:.3},NORMAL:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,randomFactor:0},HARD:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,lookahead:1}};class D{findBestMove(t,e,s){s.randomFactor&&Math.random()<s.randomFactor;let i=-1/0,a=null;for(let n=0;n<4;n++){const o=e.clone();o.setRotation(n);const T=o.getBlocks();for(let m=-2;m<g.WIDTH+2;m++){t.isValidPosition(T,m,0);let p=-1;if(!t.isValidPosition(T,m,0))continue;for(let x=0;x<g.TOTAL_ROWS&&t.isValidPosition(T,m,x);x++)p=x;if(p===-1)continue;const E=this.evaluateMove(t,T,m,p,e.type,s);E>i&&(i=E,a={x:m,rotation:n,score:E})}}return a}evaluateMove(t,e,s,i,a,n){const o=t.clone(),T=R[a]||1;o.lockPiece(e,s,i,T);const m=o.clearLines(),p=o.getAggregateHeight(),E=o.countHoles(),x=o.getBumpiness();let L=0;return L+=p*n.heightWeight,L+=m*n.linesWeight,L+=E*n.holesWeight,L+=x*n.bumpinessWeight,L}}const B={easy:b.EASY,normal:b.NORMAL,hard:b.HARD,god:{...b.HARD,lookahead:2,heightWeight:-.8}};class S{static generateLevel(t){let e="easy",s=5,i=500,a,n=3;return t<=10?(e="easy",s=3+Math.floor(t/2),i=800-t*20):t<=30?(e="normal",s=10+Math.floor((t-10)/2),i=600-(t-10)*10):t<=70?(e="hard",s=20+Math.floor((t-30)/2),i=400-(t-30)*5,a=this.generateGarbageGrid(Math.min(10,Math.floor((t-20)/5)))):(e="god",s=40+(t-70),i=200,a=this.generateGarbageGrid(8+Math.floor((t-70)/5))),t>50&&(n=4),t%10===0&&(s+=10),{id:t,name:`Level ${t}`,targetLines:s,aiDifficultyLevel:e,aiWeights:B[e],aiSpeed:Math.max(100,i),initialGrid:a,pieceChoices:n}}static generateGarbageGrid(t){const e=Array.from({length:g.TOTAL_ROWS},()=>Array(g.WIDTH).fill(0)),s=g.TOTAL_ROWS-t;for(let i=s;i<g.TOTAL_ROWS;i++){for(let n=0;n<g.WIDTH;n++)if(Math.random()>.3){const o=Math.floor(Math.random()*7)+1;e[i][n]=o}const a=Math.floor(Math.random()*g.WIDTH);e[i][a]=0}return e}}class X{constructor(t){r(this,"state",0);r(this,"grid");r(this,"renderer");r(this,"ai");r(this,"data");r(this,"currentPiece",null);r(this,"nextPieces",[]);r(this,"activePiecePosition",{x:0,y:0});r(this,"ghostPiecePosition",{x:0,y:0});r(this,"aiTimer",0);r(this,"currentAiSpeed",500);r(this,"listeners",{});this.renderer=t,this.grid=new g,this.ai=new D,this.data={level:1,linesCleared:0,piecesPlaced:0,targetLines:10,aiDifficulty:b.NORMAL}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(s=>s(e))}start(t){t?this.loadLevel(t):this.loadLevel(S.generateLevel(1))}loadLevel(t){this.data.level=t.id,this.data.targetLines=t.targetLines,this.data.aiDifficulty=t.aiWeights,this.currentAiSpeed=t.aiSpeed,this.grid=new g(t.initialGrid),this.data.linesCleared=0,this.data.piecesPlaced=0,this.state=1,this.startTurn(),this.emit("levelLoaded",t)}startTurn(){this.nextPieces=O.createRandomSet(3),this.state=1,this.emit("stateChange",this.state),this.emit("nextPieces",this.nextPieces)}selectPiece(t){this.state===1&&(t<0||t>=this.nextPieces.length||(this.currentPiece=this.nextPieces[t],this.activePiecePosition={x:4,y:0},this.emit("pieceSelected",this.currentPiece),this.state=2,this.aiTimer=0))}update(t){this.state===2&&this.currentPiece&&(this.aiTimer+=t,this.aiTimer>=this.currentAiSpeed&&(this.executeAIMove(),this.aiTimer=0))}executeAIMove(){if(!this.currentPiece)return;const t=this.ai.findBestMove(this.grid,this.currentPiece,this.data.aiDifficulty);if(t){this.currentPiece.setRotation(t.rotation);const e=this.currentPiece.getBlocks();let s=-1;for(let i=0;i<g.TOTAL_ROWS&&this.grid.isValidPosition(e,t.x,i);i++)s=i;if(s!==-1){const i=R[this.currentPiece.type];this.grid.lockPiece(e,t.x,s,i),this.data.piecesPlaced++;const a=this.grid.clearLines();a>0&&(this.data.linesCleared+=a,this.emit("linesCleared",a)),this.emit("pieceLocked"),this.checkGameStatus()}else console.error("AI returned valid move but placement failed"),this.state=4,this.emit("gameOver","win")}else{this.state=4,this.emit("gameOver","win");return}this.state===2&&this.startTurn()}checkGameStatus(){if(this.data.linesCleared>=this.data.targetLines){this.state=5,this.emit("gameOver","lose");return}if(this.grid.isGameOver()){this.state=4,this.emit("gameOver","win");return}}render(){this.renderer.clear(),this.renderer.drawGrid(this.grid),this.renderer.drawUI(this.data.linesCleared*100,this.data.level,this.data.linesCleared),this.state===1?this.renderer.drawPieceSelector(this.nextPieces,-1):this.state===2&&this.currentPiece&&this.renderer.drawPiece(this.currentPiece,this.activePiecePosition.x,this.activePiecePosition.y),this.state===4?this.renderer.drawText("YOU WIN!",300,300,50,"#0f0"):this.state===5&&this.renderer.drawText("GAME OVER",300,300,50,"#f00")}}class V{constructor(t){r(this,"canvas");r(this,"listeners",{});r(this,"UI_OFFSET_X",400);r(this,"UI_OFFSET_Y",50);r(this,"PIECE_BOX_WIDTH",100);r(this,"PIECE_BOX_HEIGHT",80);r(this,"PIECE_BOX_GAP",20);this.canvas=t,this.setupKeyboardListeners(),this.setupMouseListeners(),this.setupTouchListeners()}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(s=>s(e))}setupKeyboardListeners(){window.addEventListener("keydown",t=>{switch(t.key){case"1":this.emit("selectPiece",0);break;case"2":this.emit("selectPiece",1);break;case"3":this.emit("selectPiece",2);break;case"4":this.emit("selectPiece",3);break;case"p":case"P":this.emit("pause");break;case"r":case"R":this.emit("restart");break;case"Escape":this.emit("menu");break}})}getScaledCoordinates(t,e){const s=this.canvas.getBoundingClientRect(),i=800/s.width,a=600/s.height;return{x:(t-s.left)*i,y:(e-s.top)*a}}setupMouseListeners(){this.canvas.addEventListener("mousedown",t=>{const e=this.getScaledCoordinates(t.clientX,t.clientY);this.handlePointerDown(e.x,e.y)}),this.canvas.addEventListener("mousemove",t=>{const e=this.getScaledCoordinates(t.clientX,t.clientY);this.handlePointerMove(e.x,e.y)})}setupTouchListeners(){this.canvas.addEventListener("touchstart",t=>{t.preventDefault();const e=t.touches[0],s=this.getScaledCoordinates(e.clientX,e.clientY);this.handlePointerDown(s.x,s.y)},{passive:!1})}handlePointerDown(t,e){for(let s=0;s<3;s++){const i=this.UI_OFFSET_X,a=this.UI_OFFSET_Y+60+s*(this.PIECE_BOX_HEIGHT+this.PIECE_BOX_GAP);if(t>=i&&t<=i+this.PIECE_BOX_WIDTH&&e>=a&&e<=a+this.PIECE_BOX_HEIGHT){this.emit("selectPiece",s);return}}}handlePointerMove(t,e){let s=-1;for(let i=0;i<3;i++){const a=this.UI_OFFSET_X,n=this.UI_OFFSET_Y+60+i*(this.PIECE_BOX_HEIGHT+this.PIECE_BOX_GAP);if(t>=a&&t<=a+this.PIECE_BOX_WIDTH&&e>=n&&e<=n+this.PIECE_BOX_HEIGHT){s=i;break}}s!==-1?this.emit("hoverPiece",s):this.emit("hoverPiece",-1)}}class Y{constructor(){r(this,"ctx",null);r(this,"masterGain",null);r(this,"sfxGain",null);r(this,"bgmGain",null);r(this,"isMuted",!1);r(this,"volMaster",.5);r(this,"volSfx",.8);r(this,"volBgm",.4);r(this,"isPlayingBgm",!1)}async init(){if(!this.ctx)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.sfxGain=this.ctx.createGain(),this.bgmGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.sfxGain.connect(this.masterGain),this.bgmGain.connect(this.masterGain),this.updateVolumes()}catch(t){console.error("Audio init failed",t)}}updateVolumes(){if(!this.masterGain||!this.sfxGain||!this.bgmGain||!this.ctx)return;const t=this.ctx.currentTime;this.masterGain.gain.setValueAtTime(this.isMuted?0:this.volMaster,t),this.sfxGain.gain.setValueAtTime(this.volSfx,t),this.bgmGain.gain.setValueAtTime(this.volBgm,t)}setMute(t){this.isMuted=t,this.updateVolumes()}playSelect(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="square",t.frequency.setValueAtTime(440,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(880,this.ctx.currentTime+.1),e.gain.setValueAtTime(.1,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),t.connect(e),e.connect(this.sfxGain),t.start(),t.stop(this.ctx.currentTime+.1)}playDrop(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.createOscillator(),e=this.ctx.createGain();t.type="triangle",t.frequency.setValueAtTime(150,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.15),e.gain.setValueAtTime(.3,this.ctx.currentTime),e.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),t.connect(e),e.connect(this.sfxGain),t.start(),t.stop(this.ctx.currentTime+.2)}playClear(){if(!this.ctx||!this.sfxGain)return;const t=this.ctx.currentTime;[523.25,659.25,783.99,1046.5].forEach((s,i)=>{if(!this.ctx)return;const a=this.ctx.createOscillator(),n=this.ctx.createGain();a.type="square",a.frequency.setValueAtTime(s,t+i*.05),n.gain.setValueAtTime(.1,t+i*.05),n.gain.exponentialRampToValueAtTime(.01,t+i*.05+.1),a.connect(n),this.sfxGain&&n.connect(this.sfxGain),a.start(t+i*.05),a.stop(t+i*.05+.1)})}playGameOver(t){if(!(!this.ctx||!this.sfxGain))if(t)this.playClear();else{const e=this.ctx.createOscillator(),s=this.ctx.createGain();e.type="sawtooth",e.frequency.setValueAtTime(200,this.ctx.currentTime),e.frequency.linearRampToValueAtTime(50,this.ctx.currentTime+.5),s.gain.setValueAtTime(.2,this.ctx.currentTime),s.gain.linearRampToValueAtTime(.01,this.ctx.currentTime+.5),e.connect(s),s.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.5)}}startBgm(){this.isPlayingBgm||(this.isPlayingBgm=!0,this.scheduleBgm())}stopBgm(){this.isPlayingBgm=!1,this.ctx&&this.ctx.suspend()}scheduleBgm(){!this.isPlayingBgm||!this.ctx||this.bgmGain}}class U{constructor(){r(this,"overlays",{});r(this,"app");this.app=document.getElementById("app"),this.createOverlays(),this.show("menu")}createOverlays(){this.overlays.menu=this.createOverlay("menu-overlay",`
            <h1 class="title">REVERSE TETRIS</h1>
            <div class="menu-buttons">
                <button id="btn-start" class="btn primary">START GAME</button>
                <button id="btn-levels" class="btn">LEVELS</button>
                <button id="btn-settings" class="btn">SETTINGS</button>
            </div>
            <p class="footer">Feed the AI until it bursts.</p>
        `),this.overlays.levels=this.createOverlay("levels-overlay",`
            <h2>SELECT LEVEL</h2>
            <div class="level-grid" id="level-grid">
                <!-- Generated via JS -->
            </div>
            <button id="btn-back-levels" class="btn back">BACK</button>
        `),this.overlays.pause=this.createOverlay("pause-overlay",`
            <h2>PAUSED</h2>
            <button id="btn-resume" class="btn primary">RESUME</button>
            <button id="btn-restart-pause" class="btn">RESTART</button>
            <button id="btn-menu-pause" class="btn">MAIN MENU</button>
        `),this.overlays.win=this.createOverlay("win-overlay",`
            <h1 class="win">VICTORY!</h1>
            <p>The AI Topped Out.</p>
            <button id="btn-next-level" class="btn primary">NEXT LEVEL</button>
            <button id="btn-menu-win" class="btn">MAIN MENU</button>
        `),this.overlays.lose=this.createOverlay("lose-overlay",`
            <h1 class="lose">DEFEAT</h1>
            <p>The AI Survived your attacks.</p>
            <button id="btn-retry" class="btn primary">RETRY</button>
            <button id="btn-menu-lose" class="btn">MAIN MENU</button>
        `);const t=document.createElement("div");t.id="hud-overlay",t.className="overlay hidden",t.style.pointerEvents="none",t.innerHTML=`
            <div class="hud-top">
                <div class="hud-score">Level: <span id="hud-level">1</span></div>
                <div class="hud-target">Target: <span id="hud-target">0</span>/10 Lines</div>
            </div>
        `,this.app.appendChild(t),this.overlays.hud=t}createOverlay(t,e){const s=document.createElement("div");return s.id=t,s.className="overlay hidden",s.innerHTML=e,this.app.appendChild(s),s}show(t){Object.values(this.overlays).forEach(e=>e.classList.add("hidden")),this.overlays[t]&&this.overlays[t].classList.remove("hidden"),t==="game"&&this.overlays.hud.classList.remove("hidden")}hideAll(){Object.values(this.overlays).forEach(t=>t.classList.add("hidden"))}on(t,e,s){const i=document.getElementById(t);i&&i.addEventListener(e,s)}updateHUD(t,e,s){const i=document.getElementById("hud-level"),a=document.getElementById("hud-target");i&&(i.textContent=t.toString()),a&&(a.textContent=e.toString()+"/"+s.toString())}generateLevelGrid(t,e){const s=document.getElementById("level-grid");if(s){s.innerHTML="";for(let i=1;i<=t;i++){const a=document.createElement("button");a.className="level-btn",a.textContent=i.toString(),a.onclick=()=>e(i),s.appendChild(a)}}}}const Z=document.querySelector("#app");Z.innerHTML=`
  <div style="position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">
    <canvas id="game-canvas" width="800" height="600" style="background: #000; border: 2px solid #333;"></canvas>
  </div>
`;const y=document.getElementById("game-canvas"),I=new H(y),u=new X(I),_=new V(y),f=new Y,h=new U,v=()=>{f.init(),y.removeEventListener("mousedown",v),y.removeEventListener("touchstart",v),window.removeEventListener("keydown",v)};y.addEventListener("mousedown",v);y.addEventListener("touchstart",v);window.addEventListener("keydown",v);h.on("btn-start","click",()=>{h.show("game"),u.start(),f.playSelect()});h.on("btn-levels","click",()=>{h.generateLevelGrid(20,l=>{h.show("game"),u.loadLevel(S.generateLevel(l)),f.playSelect()}),h.show("levels"),f.playSelect()});h.on("btn-settings","click",()=>{alert("Settings not implemented yet."),f.playSelect()});h.on("btn-back-levels","click",()=>{h.show("menu"),f.playSelect()});h.on("btn-resume","click",()=>{h.show("game"),f.playSelect()});h.on("btn-restart-pause","click",()=>{h.show("game"),u.start(S.generateLevel(u.data.level)),f.playSelect()});h.on("btn-menu-pause","click",()=>{h.show("menu"),f.playSelect()});h.on("btn-next-level","click",()=>{const l=u.data.level;u.loadLevel(S.generateLevel(l+1)),h.show("game"),f.playSelect()});h.on("btn-menu-win","click",()=>{h.show("menu"),f.playSelect()});h.on("btn-retry","click",()=>{u.loadLevel(S.generateLevel(u.data.level)),h.show("game"),f.playSelect()});h.on("btn-menu-lose","click",()=>{h.show("menu"),f.playSelect()});_.on("selectPiece",l=>{f.playSelect(),u.selectPiece(l)});_.on("restart",()=>{f.playSelect(),u.start(S.generateLevel(u.data.level))});_.on("pause",()=>{h.show("pause"),f.playSelect()});_.on("menu",()=>{u.state!==0&&(h.show("pause"),f.playSelect())});u.on("pieceLocked",()=>{f.playDrop(),I.animator.triggerShake(100)});u.on("linesCleared",l=>{f.playClear(),h.updateHUD(u.data.level,u.data.linesCleared,u.data.targetLines),I.animator.spawnParticles(400,300,"#ffcc00",20*l),I.animator.spawnText(400,300,`+${l} LINES`,"#fff"),I.animator.triggerShake(300)});u.on("levelLoaded",l=>{h.updateHUD(l.id,0,l.targetLines)});u.on("gameOver",l=>{f.playGameOver(l==="win"),l==="win"?h.show("win"):h.show("lose")});let A=0;function P(l){const t=l-A;A=l,u.update(t),u.render(),requestAnimationFrame(P)}requestAnimationFrame(P);
