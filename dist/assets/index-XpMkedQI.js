var N=Object.defineProperty;var F=(h,e,t)=>e in h?N(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var n=(h,e,t)=>F(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const f=class f{constructor(e){n(this,"_grid");n(this,"_ceilingRows",0);e?this._grid=e.map(t=>[...t]):this._grid=Array.from({length:f.TOTAL_ROWS},()=>Array(f.WIDTH).fill(0))}get data(){return this._grid}get ceilingRows(){return this._ceilingRows}getSpawnY(){return f.VISIBLE_START_ROW+this._ceilingRows}lowerCeiling(e=1){const t=Math.min(f.VISIBLE_ROWS,Math.max(0,this._ceilingRows+e));this._ceilingRows=t}isCeilingRow(e){return e>=f.VISIBLE_START_ROW&&e<f.VISIBLE_START_ROW+this._ceilingRows}isCellEmpty(e,t){return e<0||e>=f.WIDTH||t>=f.TOTAL_ROWS?!1:t<0?!0:this.isCeilingRow(t)?!1:this._grid[t][e]===0}isValidPosition(e,t,i){for(const s of e){const a=t+s.x,l=i+s.y;if(a<0||a>=f.WIDTH||l>=f.TOTAL_ROWS||l>=0&&this.isCeilingRow(l)||l>=0&&this._grid[l][a]!==0)return!1}return!0}lockPiece(e,t,i,s){for(const a of e){const l=t+a.x,c=i+a.y;l>=0&&l<f.WIDTH&&c>=0&&c<f.TOTAL_ROWS&&(this._grid[c][l]=s)}}isPieceTouchingCeiling(e,t,i){const s=this.getSpawnY();for(const a of e)if(i+a.y<s)return!0;return!1}clearLines(){let e=0;for(let t=f.TOTAL_ROWS-1;t>=0;t--)this.isRowFull(t)&&(this.removeRow(t),e++,t++);return e}isRowFull(e){return this._grid[e].every(t=>t!==0)}removeRow(e){this._grid.splice(e,1),this._grid.unshift(Array(f.WIDTH).fill(0))}isGameOver(){const e=this.getSpawnY();for(let t=0;t<e;t++)if(this._grid[t].some(i=>i!==0))return!0;return!1}getHeight(){for(let e=0;e<f.TOTAL_ROWS;e++)if(this._grid[e].some(t=>t!==0))return f.TOTAL_ROWS-e;return 0}countHoles(){let e=0;for(let t=0;t<f.WIDTH;t++){let i=!1;for(let s=0;s<f.TOTAL_ROWS;s++)this._grid[s][t]!==0?i=!0:i&&this._grid[s][t]===0&&e++}return e}countBlockades(){let e=0;for(let t=0;t<f.WIDTH;t++){let i=!1;for(let s=f.TOTAL_ROWS-1;s>=0;s--)this._grid[s][t]===0?i=!0:i&&e++}return e}getWellSums(){let e=0;for(let t=0;t<f.WIDTH;t++){let i=0;for(let s=0;s<f.TOTAL_ROWS;s++){if(this._grid[s][t]!==0){i=0;continue}const a=t===0?!0:this._grid[s][t-1]!==0,l=t===f.WIDTH-1?!0:this._grid[s][t+1]!==0;a&&l?(i+=1,e+=i):i=0}}return e}getAggregateHeight(){let e=0;for(let t=0;t<f.WIDTH;t++)for(let i=0;i<f.TOTAL_ROWS;i++)if(this._grid[i][t]!==0){e+=f.TOTAL_ROWS-i;break}return e}getBumpiness(){let e=0,t=this.getColumnHeight(0);for(let i=1;i<f.WIDTH;i++){const s=this.getColumnHeight(i);e+=Math.abs(t-s),t=s}return e}getColumnHeight(e){for(let t=0;t<f.TOTAL_ROWS;t++)if(this._grid[t][e]!==0)return f.TOTAL_ROWS-t;return 0}clone(){const e=new f;return e._grid=this._grid.map(t=>[...t]),e._ceilingRows=this._ceilingRows,e}};n(f,"WIDTH",10),n(f,"HEIGHT",20),n(f,"TOTAL_ROWS",22),n(f,"VISIBLE_ROWS",20),n(f,"VISIBLE_START_ROW",2);let T=f;var g=(h=>(h.I="I",h.O="O",h.T="T",h.S="S",h.Z="Z",h.J="J",h.L="L",h.LONG_I="LONG_I",h.CROSS="CROSS",h.SQUARE_HOLLOW="SQUARE_HOLLOW",h))(g||{});const U={[g.I]:[[[-1,0],[0,0],[1,0],[2,0]],[[1,-1],[1,0],[1,1],[1,2]],[[-1,1],[0,1],[1,1],[2,1]],[[0,-1],[0,0],[0,1],[0,2]]],[g.O]:[[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]],[[0,0],[1,0],[0,1],[1,1]]],[g.T]:[[[0,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[0,1]]],[g.S]:[[[0,-1],[1,-1],[-1,0],[0,0]],[[0,-1],[0,0],[1,0],[1,1]],[[0,0],[1,0],[-1,1],[0,1]],[[-1,-1],[-1,0],[0,0],[0,1]]],[g.Z]:[[[-1,-1],[0,-1],[0,0],[1,0]],[[1,-1],[0,0],[1,0],[0,1]],[[-1,0],[0,0],[0,1],[1,1]],[[0,-1],[-1,0],[0,0],[-1,1]]],[g.J]:[[[-1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[1,-1],[0,0],[0,1]],[[-1,0],[0,0],[1,0],[1,1]],[[0,-1],[0,0],[-1,1],[0,1]]],[g.L]:[[[1,-1],[-1,0],[0,0],[1,0]],[[0,-1],[0,0],[0,1],[1,1]],[[-1,0],[0,0],[1,0],[-1,1]],[[-1,-1],[0,-1],[0,0],[0,1]]],[g.LONG_I]:[[[-2,0],[-1,0],[0,0],[1,0],[2,0],[3,0]],[[0,-2],[0,-1],[0,0],[0,1],[0,2],[0,3]],[[-2,0],[-1,0],[0,0],[1,0],[2,0],[3,0]],[[0,-2],[0,-1],[0,0],[0,1],[0,2],[0,3]]],[g.CROSS]:[[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]],[[0,-1],[-1,0],[0,0],[1,0],[0,1]]],[g.SQUARE_HOLLOW]:[[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]]]},z={[g.I]:"#00f0f0",[g.O]:"#f0f000",[g.T]:"#a000f0",[g.S]:"#00f000",[g.Z]:"#f00000",[g.J]:"#0000f0",[g.L]:"#f0a000",[g.LONG_I]:"#FFD700",[g.CROSS]:"#FFD700",[g.SQUARE_HOLLOW]:"#FFD700"},$={[g.I]:1,[g.O]:2,[g.T]:3,[g.S]:4,[g.Z]:5,[g.J]:6,[g.L]:7,[g.LONG_I]:8,[g.CROSS]:8,[g.SQUARE_HOLLOW]:8},q={1:"#00f0f0",2:"#f0f000",3:"#a000f0",4:"#00f000",5:"#f00000",6:"#0000f0",7:"#f0a000",8:"#FFD700"};class Q{constructor(){n(this,"particles",[]);n(this,"texts",[]);n(this,"shakeX",0);n(this,"shakeY",0);n(this,"shakeTime",0)}update(e){if(this.particles=this.particles.filter(t=>(t.x+=t.vx*(e/16),t.y+=t.vy*(e/16),t.life-=e,t.life>0)),this.texts=this.texts.filter(t=>(t.y+=t.vy*(e/16),t.life-=e,t.life>0)),this.shakeTime>0){this.shakeTime-=e;const t=Math.min(10,this.shakeTime/20);this.shakeX=(Math.random()-.5)*t,this.shakeY=(Math.random()-.5)*t}else this.shakeX=0,this.shakeY=0}draw(e){this.particles.forEach(t=>{e.globalAlpha=t.life/t.maxLife,e.fillStyle=t.color,e.fillRect(t.x,t.y,t.size,t.size)}),e.globalAlpha=1,this.texts.forEach(t=>{e.globalAlpha=t.life/t.maxLife,e.fillStyle=t.color,e.font="bold 20px Arial",e.fillText(t.text,t.x,t.y)}),e.globalAlpha=1}getShake(){return{x:this.shakeX,y:this.shakeY}}spawnParticles(e,t,i,s=10){for(let a=0;a<s;a++)this.particles.push({x:e,y:t,vx:(Math.random()-.5)*5,vy:(Math.random()-.5)*5,life:500+Math.random()*500,maxLife:1e3,color:i,size:2+Math.random()*3})}spawnText(e,t,i,s="#fff"){this.texts.push({x:e,y:t,text:i,color:s,life:1e3,maxLife:1e3,vy:-1})}triggerShake(e=200){this.shakeTime=e}}class K{constructor(e){n(this,"canvas");n(this,"ctx");n(this,"width",800);n(this,"height",600);n(this,"animator");n(this,"layout",{cellSize:24,gridX:0,gridY:0,gridWidth:0,gridHeight:0,selectionY:20,selectionHeight:80,selectionX:0,slotWidth:0,isPortrait:!1});n(this,"VISIBLE_START_ROW",2);this.canvas=e,this.ctx=e.getContext("2d"),this.animator=new Q,this.handleResize(),window.addEventListener("resize",()=>this.handleResize())}handleResize(){const e=window.devicePixelRatio||1;this.width=window.innerWidth,this.height=window.innerHeight,this.canvas.width=this.width*e,this.canvas.height=this.height*e,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(e,e),this.recalculateLayout()}recalculateLayout(){const e=T.WIDTH,t=T.TOTAL_ROWS-this.VISIBLE_START_ROW,i=this.height>this.width;if(this.layout.isPortrait=i,this.layout.selectionHeight=70,i){this.layout.selectionY=10;const s=this.layout.selectionY+this.layout.selectionHeight+10,a=this.height-s-60,l=this.width-20,c=Math.floor(a/t),d=Math.floor(l/e);let o=Math.min(c,d);o=Math.min(o,35),o=Math.max(o,12),this.layout.cellSize=o,this.layout.gridWidth=e*o,this.layout.gridHeight=t*o,this.layout.gridX=Math.floor((this.width-this.layout.gridWidth)/2),this.layout.gridY=s}else{this.layout.selectionY=15;const s=this.width-200,a=this.height-130,l=Math.floor(a/t),c=Math.floor(s/e);let d=Math.min(l,c);d=Math.min(d,30),d=Math.max(d,15),this.layout.cellSize=d,this.layout.gridWidth=e*d,this.layout.gridHeight=t*d,this.layout.gridX=Math.floor((this.width-this.layout.gridWidth)/2)-60,this.layout.gridY=110}this.layout.selectionX=this.layout.gridX,this.layout.slotWidth=this.layout.gridWidth/3}clear(){this.ctx.fillStyle="#1a1a1a",this.ctx.fillRect(0,0,this.width,this.height),this.animator.draw(this.ctx)}update(e){this.animator.update(e)}drawAnimations(){this.animator.draw(this.ctx)}drawGrid(e){const t=this.animator.getShake();this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.fillStyle="#111",this.ctx.fillRect(this.layout.gridX,this.layout.gridY,this.layout.gridWidth,this.layout.gridHeight),this.ctx.strokeStyle="#333",this.ctx.lineWidth=1,this.ctx.beginPath();for(let o=0;o<=T.WIDTH;o++){const r=this.layout.gridX+o*this.layout.cellSize;this.ctx.moveTo(r,this.layout.gridY),this.ctx.lineTo(r,this.layout.gridY+this.layout.gridHeight)}for(let o=0;o<=T.TOTAL_ROWS-this.VISIBLE_START_ROW;o++){const r=this.layout.gridY+o*this.layout.cellSize;this.ctx.moveTo(this.layout.gridX,r),this.ctx.lineTo(this.layout.gridX+this.layout.gridWidth,r)}this.ctx.stroke(),this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.strokeRect(this.layout.gridX-2,this.layout.gridY-2,this.layout.gridWidth+4,this.layout.gridHeight+4);const i=e.ceilingRows,s=i*this.layout.cellSize;i>0&&(this.ctx.fillStyle="rgba(10, 10, 10, 0.85)",this.ctx.fillRect(this.layout.gridX,this.layout.gridY,this.layout.gridWidth,s));const a=this.layout.gridY+s,l=performance.now()/1e3,c=(Math.sin(l*3)+1)/2;this.ctx.save(),this.ctx.shadowBlur=8+4*c,this.ctx.shadowColor="#ff3333",this.ctx.strokeStyle=`rgba(255, 50, 50, ${.7+.3*c})`,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(this.layout.gridX-2,a),this.ctx.lineTo(this.layout.gridX+this.layout.gridWidth+2,a),this.ctx.stroke(),this.layout.cellSize>15&&(this.ctx.fillStyle=`rgba(255, 80, 80, ${.4+.4*c})`,this.ctx.font="bold 10px Arial",this.ctx.textAlign="right",this.ctx.fillText("CEILING",this.layout.gridX-5,a+4)),this.ctx.restore();const d=e.data;for(let o=this.VISIBLE_START_ROW;o<T.TOTAL_ROWS;o++)for(let r=0;r<T.WIDTH;r++){const x=d[o][r],S=q[x];x!==0&&S&&this.drawCell(this.layout.gridX+r*this.layout.cellSize,this.layout.gridY+(o-this.VISIBLE_START_ROW)*this.layout.cellSize,S)}this.ctx.restore()}drawPiece(e,t,i,s){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y);const l=e.getBlocks(s),c=e.getColor();for(const d of l){const o=this.layout.gridX+(t+d.x)*this.layout.cellSize,r=this.layout.gridY+(i+d.y-this.VISIBLE_START_ROW)*this.layout.cellSize;i+d.y>=this.VISIBLE_START_ROW&&this.drawCell(o,r,c)}this.ctx.restore()}drawGhostPiece(e,t,i,s){const a=this.animator.getShake();this.ctx.save(),this.ctx.translate(a.x,a.y),this.ctx.globalAlpha=.3;const l=e.getBlocks(s),c=e.getColor();for(const d of l){const o=this.layout.gridX+(t+d.x)*this.layout.cellSize,r=this.layout.gridY+(i+d.y-this.VISIBLE_START_ROW)*this.layout.cellSize;i+d.y>=this.VISIBLE_START_ROW&&this.drawCell(o,r,c,!0)}this.ctx.globalAlpha=1,this.ctx.restore()}drawCell(e,t,i,s=!1){const a=this.layout.cellSize-2;if(this.ctx.fillStyle=i,this.ctx.fillRect(e+1,t+1,a,a),s||(this.ctx.fillStyle="rgba(255,255,255,0.3)",this.ctx.fillRect(e+1,t+1,a,a/3)),!s&&i==="#FFD700"){const l=performance.now()/500,c=(Math.sin(l)+1)/2*.4+.1;this.ctx.save(),this.ctx.strokeStyle=`rgba(255, 255, 200, ${c})`,this.ctx.lineWidth=2,this.ctx.shadowBlur=10,this.ctx.shadowColor="#FFD700",this.ctx.strokeRect(e+2,t+2,a-2,a-2),this.ctx.restore()}}drawPieceSelector(e,t){const i=Math.min(14,this.layout.cellSize*.55);this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.strokeRect(this.layout.selectionX-2,this.layout.selectionY-2,this.layout.gridWidth+4,this.layout.selectionHeight+4),this.ctx.fillStyle="#aaa",this.ctx.font="12px Arial",this.ctx.textAlign="left",this.ctx.fillText("CANDIDATES",this.layout.selectionX,this.layout.selectionY-8);const s=this.layout.slotWidth;e.forEach((a,l)=>{const c=this.layout.selectionX+l*s+s/2,d=this.layout.selectionY+this.layout.selectionHeight/2;l===t&&(this.ctx.fillStyle="rgba(255,255,255,0.1)",this.ctx.fillRect(this.layout.selectionX+l*s,this.layout.selectionY,s,this.layout.selectionHeight));const o=a.getBlocks(),r=a.getColor();let x=0,S=0,m=0,b=0;o.forEach(A=>{x=Math.min(x,A.x),S=Math.max(S,A.x),m=Math.min(m,A.y),b=Math.max(b,A.y)});const w=(S-x+1)*i,y=(b-m+1)*i,O=c-w/2-x*i,k=d-y/2-m*i;for(const A of o){const L=O+A.x*i,D=k+A.y*i,P=i-1;this.ctx.fillStyle=r,this.ctx.fillRect(L,D,P,P),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(L,D,P,P/3)}this.ctx.fillStyle="#888",this.ctx.font="10px Arial",this.ctx.textAlign="center",this.ctx.fillText(`${l+1}`,c,this.layout.selectionY+this.layout.selectionHeight-5)})}drawUI(e,t,i,s,a,l,c,d){this.ctx.textAlign="left",this.ctx.font="12px Arial";let o,r;if(this.layout.isPortrait)o=this.layout.gridX,r=this.layout.gridY+this.layout.gridHeight+20,this.drawText("SCORE",o,r,12,"#aaa"),this.drawText(`${e}`,o,r+20,20,"#fff"),this.drawText("LEVEL",o+100,r,12,"#aaa"),this.drawText(`${t}`,o+100,r+20,20,"#fff"),this.drawText("AI LINES",o+200,r,12,"#aaa"),this.drawText(`${i}/${s}`,o+200,r+20,20,"#fff"),this.drawText("BLOCKS",o+300,r,12,"#aaa"),this.drawText(`${a}`,o+300,r+20,20,"#fff"),this.drawText("AI wins when it reaches the target.",o,r+48,12,"#666"),this.drawText("You win if AI tops out.",o,r+64,12,"#666"),l&&(this.drawText("DIFF",o+400,r,12,"#aaa"),this.drawText(`${l.toUpperCase()}`,o+400,r+20,18,"#fff")),c&&(this.drawText("WELLS",o+480,r,12,"#aaa"),this.drawText(`${c.wellSums}`,o+480,r+20,18,"#fff"),this.drawText("HOLES",o+530,r,12,"#aaa"),this.drawText(`${c.holes}`,o+530,r+20,18,"#fff")),d&&(this.drawText("VER",o+580,r,12,"#666"),this.drawText(d,o+580,r+20,12,"#888"));else{o=this.layout.gridX+this.layout.gridWidth+20,r=this.layout.gridY;const x=this.layout.gridY+this.layout.gridHeight;if(this.drawText("SCORE",o,r+20,14,"#aaa"),this.drawText(`${e}`,o,r+50,24,"#fff"),this.drawText("LEVEL",o,r+100,14,"#aaa"),this.drawText(`${t}`,o,r+130,24,"#fff"),this.drawText("AI LINES",o,r+180,14,"#aaa"),this.drawText(`${i}/${s}`,o,r+210,24,"#fff"),this.drawText("BLOCKS",o,r+260,14,"#aaa"),this.drawText(`${a}`,o,r+290,24,"#fff"),this.drawText("AI wins at target lines.",o,r+318,12,"#666"),this.drawText("You win if AI tops out.",o,r+336,12,"#666"),l&&(this.drawText("DIFFICULTY",o,r+360,14,"#aaa"),this.drawText(`${l.toUpperCase()}`,o,r+390,22,"#fff")),c){const S=r+430;this.drawText(`HOLES ${c.holes} (+${c.holesCreated})`,o,S,14,"#aaa"),this.drawText(`BLOCK ${c.blockades}   WELLS ${c.wellSums}`,o,S+24,14,"#aaa"),c.lastMove&&this.drawText(`PRED H${c.lastMove.holes} (+${c.lastMove.holesCreated}) B${c.lastMove.blockades} W${c.lastMove.wellSums} L${c.lastMove.linesCleared}`,o,S+48,12,"#888")}d&&this.drawText(d,o,x-18,12,"#666"),this.drawText("D:DEBUG  V:VERSION  S:LOG",o,x-2,12,"#555")}}drawText(e,t,i,s=30,a="#fff",l="left"){this.ctx.fillStyle=a,this.ctx.font=`${s}px Arial`,this.ctx.textAlign=l,this.ctx.fillText(e,t,i)}}class B{constructor(e){n(this,"type");n(this,"_rotation");this.type=e,this._rotation=0}get rotation(){return this._rotation}rotateClockwise(){this._rotation=(this._rotation+1)%4}rotateCounterClockwise(){this._rotation=(this._rotation+3)%4}setRotation(e){this._rotation=e%4}getBlocks(e){const t=e!==void 0?e%4:this._rotation;return U[this.type][t].map(([a,l])=>({x:a,y:l}))}getColor(){return z[this.type]}clone(){const e=new B(this.type);return e.setRotation(this._rotation),e}}class G{static createRandom(e){const t=(e==null?void 0:e.specialChance)??.01;if(Math.random()<t){const s=[g.LONG_I,g.CROSS,g.SQUARE_HOLLOW],a=s[Math.floor(Math.random()*s.length)];return new B(a)}this.bag.length===0&&this.refillBag();const i=this.bag.pop();return new B(i)}static createRandomSet(e,t){const i=[];for(let s=0;s<e;s++)i.push(this.createRandom(t));return i}static refillBag(){this.bag=[...this.types];for(let e=this.bag.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}}n(G,"types",[g.I,g.O,g.T,g.S,g.Z,g.J,g.L]),n(G,"bag",[]);const R={EASY:{heightWeight:-.3,linesWeight:.5,holesWeight:-.5,bumpinessWeight:-.2,randomFactor:.3},NORMAL:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,randomFactor:0},HARD:{heightWeight:-.51,linesWeight:.76,holesWeight:-.36,bumpinessWeight:-.18,lookahead:1},GOD:{heightWeight:-.6,linesWeight:2.5,holesWeight:-.9,wellsWeight:-.25,bumpinessWeight:-.22,lexicographic:!0,preferEdges:!0}};class J{constructor(){n(this,"traceEnabled",!1);n(this,"traceTopK",12);n(this,"lastTrace",null)}setTraceEnabled(e,t=12){this.traceEnabled=e,this.traceTopK=Math.max(1,Math.min(50,Math.floor(t))),e||(this.lastTrace=null)}getLastTrace(){return this.lastTrace}findBestMove(e,t,i){let s=-1/0,a=null,l=null;const c=this.traceEnabled?[]:[],d=e.getSpawnY(),o=this.computeHoleMap(e);for(let r=0;r<4;r++){const x=t.clone();x.setRotation(r);const S=x.getBlocks();for(let m=-2;m<T.WIDTH+2;m++){let b=-1;for(let L=d;L<T.TOTAL_ROWS&&e.isValidPosition(S,m,L);L++)b=L;if(b===-1)continue;const w=this.computeEdgeDistance(S,m),y=this.evaluateMove(e,o,S,m,b,t.type,i);let O=y.score;if(i.randomFactor&&i.randomFactor>0){const L=(Math.random()-.5)*i.randomFactor*50;O+=L}const k={gameOverAfterMove:y.gameOverAfterMove,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,wellSums:y.wellSums,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,bumpiness:y.bumpiness,edgeDistance:w};(i.lexicographic?this.isBetterLexicographic(k,a,!!i.preferEdges):O>s)&&(a=k,s=O,l={x:m,rotation:r,score:O,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,maxHeight:y.maxHeight,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,bumpiness:y.bumpiness,gameOverAfterMove:y.gameOverAfterMove,edgeDistance:w,wellSums:y.wellSums}),this.traceEnabled&&c.push({x:m,rotation:r,y:b,score:O,linesCleared:y.linesCleared,aggregateHeight:y.aggregateHeight,maxHeight:y.maxHeight,holes:y.holes,holesCreated:y.holesCreated,blockades:y.blockades,bumpiness:y.bumpiness,gameOverAfterMove:y.gameOverAfterMove,edgeDistance:w,wellSums:y.wellSums})}}if(this.traceEnabled){const r=[...c].sort((w,y)=>this.compareCandidates(w,y,i)),x=r[0],S=r[1],m=i.lexicographic?["topOut","linesCleared","holes","holesCreated","blockades","wellSums","aggregateHeight","bumpiness",...i.preferEdges?["edgeDistance"]:[],"score"]:["score"],b=x&&S?this.getDecisionReason(x,S,i):void 0;x?this.lastTrace={pieceType:t.type,difficultyFlags:{lexicographic:!!i.lexicographic,preferEdges:!!i.preferEdges},weights:i,best:x,top:r.slice(0,this.traceTopK),totalCandidates:c.length,decisionOrder:m,decidedBy:b}:this.lastTrace=null}return l||{x:4,rotation:0,score:-1e6,linesCleared:0,aggregateHeight:0,maxHeight:22,holes:0,holesCreated:0,blockades:0,bumpiness:0,gameOverAfterMove:!0,edgeDistance:0,wellSums:0}}compareCandidates(e,t,i){if(!i.lexicographic)return t.score-e.score;const s=e.linesCleared*3-e.holesCreated,a=t.linesCleared*3-t.holesCreated;return e.gameOverAfterMove!==t.gameOverAfterMove?e.gameOverAfterMove?1:-1:s!==a?a-s:e.linesCleared!==t.linesCleared?t.linesCleared-e.linesCleared:e.holes!==t.holes?e.holes-t.holes:e.blockades!==t.blockades?e.blockades-t.blockades:e.wellSums!==t.wellSums?e.wellSums-t.wellSums:e.aggregateHeight!==t.aggregateHeight?e.aggregateHeight-t.aggregateHeight:e.bumpiness!==t.bumpiness?e.bumpiness-t.bumpiness:i.preferEdges&&e.edgeDistance!==t.edgeDistance?e.edgeDistance-t.edgeDistance:t.score-e.score}getDecisionReason(e,t,i){if(!i.lexicographic)return e.score!==t.score?{key:"score",best:e.score,second:t.score}:void 0;if(e.gameOverAfterMove!==t.gameOverAfterMove)return{key:"topOut",best:e.gameOverAfterMove,second:t.gameOverAfterMove};if(e.linesCleared!==t.linesCleared)return{key:"linesCleared",best:e.linesCleared,second:t.linesCleared};if(e.holes!==t.holes)return{key:"holes",best:e.holes,second:t.holes};if(e.holesCreated!==t.holesCreated)return{key:"holesCreated",best:e.holesCreated,second:t.holesCreated};if(e.blockades!==t.blockades)return{key:"blockades",best:e.blockades,second:t.blockades};if(e.wellSums!==t.wellSums)return{key:"wellSums",best:e.wellSums,second:t.wellSums};if(e.aggregateHeight!==t.aggregateHeight)return{key:"aggregateHeight",best:e.aggregateHeight,second:t.aggregateHeight};if(e.bumpiness!==t.bumpiness)return{key:"bumpiness",best:e.bumpiness,second:t.bumpiness};if(i.preferEdges&&e.edgeDistance!==t.edgeDistance)return{key:"edgeDistance",best:e.edgeDistance,second:t.edgeDistance};if(e.score!==t.score)return{key:"score",best:e.score,second:t.score}}isBetterLexicographic(e,t,i){if(!t)return!0;const s=e.linesCleared*3-e.holesCreated,a=t.linesCleared*3-t.holesCreated;return e.gameOverAfterMove!==t.gameOverAfterMove?e.gameOverAfterMove===!1:s!==a?s>a:e.linesCleared!==t.linesCleared?e.linesCleared>t.linesCleared:e.holes!==t.holes?e.holes<t.holes:e.blockades!==t.blockades?e.blockades<t.blockades:e.wellSums!==t.wellSums?e.wellSums<t.wellSums:e.aggregateHeight!==t.aggregateHeight?e.aggregateHeight<t.aggregateHeight:e.bumpiness!==t.bumpiness?e.bumpiness<t.bumpiness:i&&e.edgeDistance!==t.edgeDistance?e.edgeDistance<t.edgeDistance:!1}computeEdgeDistance(e,t){let i=1/0;for(const s of e){const a=t+s.x,l=Math.min(a,T.WIDTH-1-a);l<i&&(i=l)}return i===1/0?0:i}evaluateMove(e,t,i,s,a,l,c){const d=e.clone(),o=$[l]||1;d.lockPiece(i,s,a,o);const r=d.clearLines(),x=d.getAggregateHeight(),S=d.getHeight(),m=d.getWellSums(),b=d.countHoles(),w=this.computeHoleMap(d),y=this.countNewHoles(t,w),O=d.countBlockades(),k=d.getBumpiness(),A=d.isGameOver();let L=0;A&&(L-=1e6),L+=x*c.heightWeight,L+=r*c.linesWeight,L+=b*c.holesWeight,L+=O*(c.holesWeight*.5);const D=c.wellsWeight??c.holesWeight*.25;return L+=m*D,L+=k*c.bumpinessWeight,{score:L,linesCleared:r,aggregateHeight:x,maxHeight:S,holes:b,holesCreated:y,blockades:O,wellSums:m,bumpiness:k,gameOverAfterMove:A}}computeHoleMap(e){const t=Array.from({length:T.TOTAL_ROWS},()=>Array(T.WIDTH).fill(!1));for(let i=0;i<T.WIDTH;i++){let s=!1;for(let a=0;a<T.TOTAL_ROWS;a++)e.data[a][i]!==0?s=!0:s&&(t[a][i]=!0)}return t}countNewHoles(e,t){let i=0;for(let s=0;s<T.TOTAL_ROWS;s++)for(let a=0;a<T.WIDTH;a++)t[s][a]&&!e[s][a]&&i++;return i}}const j={easy:R.EASY,normal:R.NORMAL,hard:R.HARD,god:{...R.GOD,lookahead:2}};class I{static generateLevel(e){let t="easy",i=12,s=500,a,l=3;return e<=10?(t="easy",i=10+Math.floor(e/2),s=800-e*20):e<=30?(t="normal",i=17+Math.floor((e-10)/2),s=600-(e-10)*10):e<=70?(t="hard",i=30+Math.floor((e-30)/2),s=400-(e-30)*5,a=this.generateGarbageGrid(Math.min(10,Math.floor((e-20)/5)))):(t="god",i=55+(e-70),s=200,a=this.generateGarbageGrid(8+Math.floor((e-70)/5))),e>50&&(l=4),e%10===0&&(i+=10),{id:e,name:`Level ${e}`,targetLines:i,aiDifficultyLevel:t,aiWeights:j[t],aiSpeed:Math.max(100,s),initialGrid:a,pieceChoices:l}}static generateGarbageGrid(e){const t=Array.from({length:T.TOTAL_ROWS},()=>Array(T.WIDTH).fill(0)),i=T.TOTAL_ROWS-e;for(let s=i;s<T.TOTAL_ROWS;s++){for(let l=0;l<T.WIDTH;l++)if(Math.random()>.3){const c=Math.floor(Math.random()*7)+1;t[s][l]=c}const a=Math.floor(Math.random()*T.WIDTH);t[s][a]=0}return t}}class Z{constructor(e){n(this,"state",0);n(this,"grid");n(this,"renderer");n(this,"ai");n(this,"data");n(this,"currentPiece",null);n(this,"nextPieces",[]);n(this,"activePiecePosition",{x:0,y:0});n(this,"ghostPiecePosition",{x:0,y:0});n(this,"debugHudEnabled",!1);n(this,"versionHudEnabled",!0);n(this,"appVersion","");n(this,"difficultyOverride",null);n(this,"decisionLogVisible",!1);n(this,"lastDecisionLogText","");n(this,"aiTimer",0);n(this,"currentAiSpeed",500);n(this,"moveQueue",[]);n(this,"animationTimer",0);n(this,"lastAiMove",null);n(this,"listeners",{});this.renderer=e,this.grid=new T,this.ai=new J,this.ai.setTraceEnabled(!0,12),this.data={level:1,linesCleared:0,piecesPlaced:0,targetLines:10,aiDifficulty:R.NORMAL,aiDifficultyLevel:"normal"}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(i=>i(t))}setDifficulty(e){this.data.aiDifficulty=R[e],this.data.aiDifficultyLevel=e.toLowerCase();let t=500;switch(e){case"EASY":this.currentAiSpeed=800,t=800;break;case"NORMAL":this.currentAiSpeed=500,t=500;break;case"HARD":this.currentAiSpeed=300,t=300;break;case"GOD":this.currentAiSpeed=200,t=200;break}this.difficultyOverride={level:this.data.aiDifficultyLevel,weights:this.data.aiDifficulty,speedMs:t}}start(e){e?this.loadLevel(e):this.loadLevel(I.generateLevel(1))}loadLevel(e){this.data.level=e.id,this.data.targetLines=e.targetLines,this.difficultyOverride?(this.data.aiDifficulty=this.difficultyOverride.weights,this.data.aiDifficultyLevel=this.difficultyOverride.level,this.currentAiSpeed=this.difficultyOverride.speedMs):(this.data.aiDifficulty=e.aiWeights,this.data.aiDifficultyLevel=e.aiDifficultyLevel,this.currentAiSpeed=e.aiSpeed),this.grid=new T(e.initialGrid),this.data.linesCleared=0,this.data.piecesPlaced=0,this.state=1,this.startTurn(),this.emit("levelLoaded",e)}startTurn(){this.nextPieces=G.createRandomSet(3,{specialChance:this.getSpecialChanceForDifficulty()}),this.state=1,this.emit("stateChange",this.state),this.emit("nextPieces",this.nextPieces)}getSpecialChanceForDifficulty(){switch(this.data.aiDifficultyLevel){case"easy":return .1;case"normal":return .08;case"hard":return .06;case"god":return .04;default:return .01}}getCeilingDropInterval(){switch(this.data.aiDifficultyLevel){case"easy":return 5;case"normal":return 8;case"hard":return 12;case"god":return 15;default:return 10}}selectPiece(e){this.state===1&&(e<0||e>=this.nextPieces.length||(this.currentPiece=this.nextPieces[e],this.activePiecePosition={x:4,y:this.grid.getSpawnY()},this.emit("pieceSelected",this.currentPiece),this.state=2,this.aiTimer=0,this.prepareAIMove()))}prepareAIMove(){if(!this.currentPiece)return;const e=this.ai.findBestMove(this.grid,this.currentPiece,this.data.aiDifficulty);e&&(this.lastAiMove=e,this.updateDecisionLog(),this.generateMoveQueue(e),this.state=3,this.animationTimer=0)}updateDecisionLog(){const e=this.ai.getLastTrace();this.lastDecisionLogText=this.formatDecisionLog(e),this.decisionLogVisible&&this.emit("aiTrace",this.lastDecisionLogText)}formatDecisionLog(e){var S;const i=["ReverseTetris AI Trace",`time=${new Date().toISOString()}`,`version=${this.appVersion||"unknown"}`,`difficulty=${this.data.aiDifficultyLevel}`,`turn=${this.data.piecesPlaced+1}`].join(`
`),s=JSON.stringify(this.grid.data);if(!e){const m=this.currentPiece?this.currentPiece.type:"(none)",b=((S=this.nextPieces)==null?void 0:S.map(w=>w.type).join(","))??"";return`${i}
currentPiece=${m}
nextPieces=[${b}]

(no trace available)

grid=${s}
`}const a=`lexicographic=${e.difficultyFlags.lexicographic} preferEdges=${e.difficultyFlags.preferEdges}`,l=JSON.stringify(e.weights),c=e.decidedBy?`decidedBy=${e.decidedBy.key} best=${e.decidedBy.best} second=${e.decidedBy.second}`:"decidedBy=(tie)",d=`order=${e.decisionOrder.join(" > ")}`,o=m=>`x=${m.x} r=${m.rotation} y=${m.y} H=${m.holes}(+${m.holesCreated}) B=${m.blockades} W=${m.wellSums} L=${m.linesCleared} MH=${m.maxHeight} AH=${m.aggregateHeight} BU=${m.bumpiness} E=${m.edgeDistance} S=${Math.round(m.score*100)/100}`+(m.gameOverAfterMove?" TOP_OUT":""),r=`best: ${e.pieceType} ${o(e.best)}`,x=e.top.map((m,b)=>`${b+1}. ${e.pieceType} ${o(m)}`).join(`
`);return`${i}
${a}
${d}
${c}
weights=${l}

${r}

top(${e.top.length}/${e.totalCandidates}):
${x}

grid=${s}
`}generateMoveQueue(e){this.moveQueue=[];let t=e.rotation;for(let a=0;a<t;a++)this.moveQueue.push({type:"rotate",value:1});const s=e.x-4;if(s!==0){const a=s>0?1:-1;for(let l=0;l<Math.abs(s);l++)this.moveQueue.push({type:"move",value:a})}this.moveQueue.push({type:"drop",value:0})}update(e){if(this.state===2&&(this.aiTimer+=e,this.aiTimer>200&&this.prepareAIMove()),this.state===3&&this.currentPiece){this.animationTimer+=e;const t=this.moveQueue.length||1,i=Math.max(30,Math.min(200,this.currentAiSpeed/t));this.animationTimer>=i&&(this.animationTimer=0,this.processAnimationStep())}}processAnimationStep(){var t;if(this.moveQueue.length===0)return;const e=this.moveQueue.shift();e&&(e.type==="rotate"?(t=this.currentPiece)==null||t.rotateClockwise():e.type==="move"?this.activePiecePosition.x+=e.value:e.type==="drop"&&this.executeDropAndLock())}executeDropAndLock(){if(!this.currentPiece)return;const e=this.currentPiece.getBlocks(),t=this.grid.getSpawnY();let i=t;for(let c=t;c<T.TOTAL_ROWS&&this.grid.isValidPosition(e,this.activePiecePosition.x,c);c++)i=c;this.activePiecePosition.y=i;const s=$[this.currentPiece.type];if(this.grid.lockPiece(e,this.activePiecePosition.x,i,s),this.data.piecesPlaced++,this.grid.isPieceTouchingCeiling(e,this.activePiecePosition.x,i)){this.state=5,this.emit("pieceLocked"),this.emit("gameOver","win");return}const a=this.grid.clearLines();a>0&&(this.data.linesCleared+=a,this.emit("linesCleared",a));const l=this.getCeilingDropInterval();l>0&&this.data.piecesPlaced>0&&this.data.piecesPlaced%l===0&&this.grid.lowerCeiling(1),this.emit("pieceLocked"),this.checkGameStatus(),this.state!==5&&this.state!==6&&this.state===3&&this.startTurn()}checkGameStatus(){if(this.data.linesCleared>=this.data.targetLines){this.state=6,this.emit("gameOver","lose");return}if(this.grid.isGameOver()){this.state=5,this.emit("gameOver","win");return}}render(){var e;if(this.renderer.clear(),this.renderer.drawGrid(this.grid),this.renderer.drawUI(this.data.linesCleared*100,this.data.level,this.data.linesCleared,this.data.targetLines,this.data.piecesPlaced,this.data.aiDifficultyLevel,this.debugHudEnabled?{wellSums:this.grid.getWellSums(),holes:this.grid.countHoles(),blockades:this.grid.countBlockades(),holesCreated:((e=this.lastAiMove)==null?void 0:e.holesCreated)??0,lastMove:this.lastAiMove?{holes:this.lastAiMove.holes,holesCreated:this.lastAiMove.holesCreated,blockades:this.lastAiMove.blockades,wellSums:this.lastAiMove.wellSums,linesCleared:this.lastAiMove.linesCleared,score:this.lastAiMove.score}:void 0}:void 0,this.versionHudEnabled?this.appVersion:void 0),this.state===1)this.renderer.drawPieceSelector(this.nextPieces,-1);else if((this.state===2||this.state===3)&&this.currentPiece){this.renderer.drawPiece(this.currentPiece,this.activePiecePosition.x,this.activePiecePosition.y);const t=this.currentPiece.getBlocks();let i=-1;for(let s=0;s<T.TOTAL_ROWS&&this.grid.isValidPosition(t,this.activePiecePosition.x,s);s++)i=s;i!==-1&&this.renderer.drawGhostPiece(this.currentPiece,this.activePiecePosition.x,i)}}toggleDebugHud(){this.debugHudEnabled=!this.debugHudEnabled}toggleVersionHud(){this.versionHudEnabled=!this.versionHudEnabled}setDecisionLogVisible(e){this.decisionLogVisible=e,e&&this.emit("aiTrace",this.lastDecisionLogText)}getLastDecisionLog(){return this.lastDecisionLogText}}class ee{constructor(e,t){n(this,"canvas");n(this,"renderer");n(this,"listeners",{});this.canvas=e,this.renderer=t,this.setupKeyboardListeners(),this.setupMouseListeners(),this.setupTouchListeners()}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(i=>i(t))}setupKeyboardListeners(){window.addEventListener("keydown",e=>{switch(e.key){case"1":this.emit("selectPiece",0);break;case"2":this.emit("selectPiece",1);break;case"3":this.emit("selectPiece",2);break;case"4":this.emit("selectPiece",3);break;case"p":case"P":this.emit("pause");break;case"r":case"R":this.emit("restart");break;case"Escape":this.emit("menu");break;case"d":case"D":this.emit("toggleDebug");break;case"v":case"V":this.emit("toggleVersion");break;case"s":case"S":this.emit("toggleAiLog");break}})}getScaledCoordinates(e,t){const i=this.canvas.getBoundingClientRect();return{x:e-i.left,y:t-i.top}}setupMouseListeners(){this.canvas.addEventListener("mousedown",e=>{const t=this.getScaledCoordinates(e.clientX,e.clientY);this.handlePointerDown(t.x,t.y)}),this.canvas.addEventListener("mousemove",e=>{const t=this.getScaledCoordinates(e.clientX,e.clientY);this.handlePointerMove(t.x,t.y)})}setupTouchListeners(){this.canvas.addEventListener("touchstart",e=>{e.preventDefault();const t=e.touches[0],i=this.getScaledCoordinates(t.clientX,t.clientY);this.handlePointerDown(i.x,i.y)},{passive:!1})}handlePointerDown(e,t){const i=this.renderer.layout;if(console.log("Click:",{x:e,y:t}),console.log("Layout:",{selectionX:i.selectionX,selectionY:i.selectionY,selectionHeight:i.selectionHeight,gridWidth:i.gridWidth,slotWidth:i.slotWidth}),t>=i.selectionY&&t<=i.selectionY+i.selectionHeight&&e>=i.selectionX&&e<=i.selectionX+i.gridWidth){const s=Math.floor((e-i.selectionX)/i.slotWidth);console.log("Hit selection! Index:",s),s>=0&&s<3&&this.emit("selectPiece",s)}}handlePointerMove(e,t){const i=this.renderer.layout;if(t>=i.selectionY&&t<=i.selectionY+i.selectionHeight&&e>=i.selectionX&&e<=i.selectionX+i.gridWidth){const s=Math.floor((e-i.selectionX)/i.slotWidth);if(s>=0&&s<3){this.emit("hoverPiece",s);return}}this.emit("hoverPiece",-1)}}class te{constructor(){n(this,"ctx",null);n(this,"masterGain",null);n(this,"sfxGain",null);n(this,"bgmGain",null);n(this,"isMuted",!1);n(this,"volMaster",.5);n(this,"volSfx",.8);n(this,"volBgm",.4);n(this,"isPlayingBgm",!1);n(this,"bgmNodes",[]);n(this,"bgmTimeout",null)}async init(){if(!this.ctx)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.sfxGain=this.ctx.createGain(),this.bgmGain=this.ctx.createGain(),this.masterGain.connect(this.ctx.destination),this.sfxGain.connect(this.masterGain),this.bgmGain.connect(this.masterGain),this.updateVolumes()}catch(e){console.error("Audio init failed",e)}}updateVolumes(){if(!this.masterGain||!this.sfxGain||!this.bgmGain||!this.ctx)return;const e=this.ctx.currentTime;this.masterGain.gain.setValueAtTime(this.isMuted?0:this.volMaster,e),this.sfxGain.gain.setValueAtTime(this.volSfx,e),this.bgmGain.gain.setValueAtTime(this.volBgm,e)}setMute(e){this.isMuted=e,this.updateVolumes()}playSelect(){if(!this.ctx||!this.sfxGain)return;const e=this.ctx.createOscillator(),t=this.ctx.createGain();e.type="square",e.frequency.setValueAtTime(440,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(880,this.ctx.currentTime+.1),t.gain.setValueAtTime(.1,this.ctx.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.1),e.connect(t),t.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.1)}playDrop(){if(!this.ctx||!this.sfxGain)return;const e=this.ctx.createOscillator(),t=this.ctx.createGain();e.type="triangle",e.frequency.setValueAtTime(150,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(50,this.ctx.currentTime+.15),t.gain.setValueAtTime(.3,this.ctx.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),e.connect(t),t.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.2)}playClear(){if(!this.ctx||!this.sfxGain)return;const e=this.ctx.currentTime;[523.25,659.25,783.99,1046.5].forEach((i,s)=>{if(!this.ctx)return;const a=this.ctx.createOscillator(),l=this.ctx.createGain();a.type="square",a.frequency.setValueAtTime(i,e+s*.05),l.gain.setValueAtTime(.1,e+s*.05),l.gain.exponentialRampToValueAtTime(.01,e+s*.05+.1),a.connect(l),this.sfxGain&&l.connect(this.sfxGain),a.start(e+s*.05),a.stop(e+s*.05+.1)})}playGameOver(e){if(!(!this.ctx||!this.sfxGain))if(e)this.playClear();else{const t=this.ctx.createOscillator(),i=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(200,this.ctx.currentTime),t.frequency.linearRampToValueAtTime(50,this.ctx.currentTime+.5),i.gain.setValueAtTime(.2,this.ctx.currentTime),i.gain.linearRampToValueAtTime(.01,this.ctx.currentTime+.5),t.connect(i),i.connect(this.sfxGain),t.start(),t.stop(this.ctx.currentTime+.5)}}toggleBgm(){this.isMuted?(this.setMute(!1),this.isPlayingBgm||this.startBgm()):this.setMute(!0)}isBgmPlaying(){return!this.isMuted}startBgm(){this.ctx&&(this.isPlayingBgm||(this.isPlayingBgm=!0,this.playBGMLoop()))}playBGMLoop(){if(!this.isPlayingBgm||!this.ctx||!this.bgmGain)return;const t=60/128,i=this.ctx.currentTime;[220,277,330].forEach(c=>{if(!this.ctx||!this.bgmGain)return;const d=this.ctx.createOscillator(),o=this.ctx.createGain();d.type="triangle",d.frequency.value=c,o.gain.setValueAtTime(.05,i),o.gain.linearRampToValueAtTime(.05,i+t*7),o.gain.linearRampToValueAtTime(0,i+t*8),d.connect(o),o.connect(this.bgmGain),d.start(i),d.stop(i+t*8),this.bgmNodes.push({osc:d,gain:o})}),[440,523,659,784,659,523,440,392].forEach((c,d)=>{if(!this.ctx||!this.bgmGain)return;const o=this.ctx.createOscillator(),r=this.ctx.createGain();o.type="sine",o.frequency.value=c;const x=i+d*t;r.gain.setValueAtTime(0,x),r.gain.linearRampToValueAtTime(.1,x+.01),r.gain.exponentialRampToValueAtTime(.01,x+t*.5),o.connect(r),r.connect(this.bgmGain),o.start(x),o.stop(x+t*.6),this.bgmNodes.push({osc:o,gain:r})});const l=t*8*1e3;this.bgmNodes=[],this.bgmTimeout=window.setTimeout(()=>{this.isPlayingBgm&&this.playBGMLoop()},l-50)}stopBgm(){this.isPlayingBgm=!1,this.bgmTimeout!==null&&(clearTimeout(this.bgmTimeout),this.bgmTimeout=null),this.bgmNodes.forEach(e=>{try{e.osc.stop(),e.osc.disconnect(),e.gain.disconnect()}catch{}}),this.bgmNodes=[]}}class ie{constructor(){n(this,"overlays",{});n(this,"app");n(this,"aiLogPanel");n(this,"aiLogVisible",!1);n(this,"aiLogTextArea",null);this.app=document.getElementById("app"),this.createOverlays(),this.aiLogPanel=this.createAiLogPanel(),this.show("menu")}createOverlays(){this.overlays.menu=this.createOverlay("menu-overlay",`
            <h1 class="title">REVERSE TETRIS</h1>
            <div class="menu-buttons">
                <button id="btn-start" class="btn primary">START GAME</button>
                <button id="btn-levels" class="btn">LEVELS</button>
                <button id="btn-howto" class="btn">HOW TO PLAY</button>
                <button id="btn-settings" class="btn">SETTINGS</button>
            </div>
            <p class="footer">Feed the AI until it bursts.</p>
        `),this.overlays.howto=this.createOverlay("howto-overlay",`
            <h2>æ¸¸æˆè¯´æ˜</h2>
            <div class="howto-content">
                <p><strong>ç›®æ ‡ï¼š</strong>è®©ç”µè„‘ AI çš„æ–¹å—å †å å¹¶è§¦ç¢°åˆ°ä¸‹è½çš„<strong>å¤©èŠ±æ¿çº¢çº¿</strong>ï¼Œä½¿å…¶"é¡¶é£"ï¼ˆTop Outï¼‰ã€‚</p>
                <p><strong>æ ¸å¿ƒè§„åˆ™ï¼š</strong></p>
                <ul>
                    <li>æ¯å›åˆä» 3 ä¸ªå€™é€‰æ–¹å—ä¸­é€‰æ‹© 1 ä¸ªåˆ†å‘ç»™ AIã€‚</li>
                    <li><strong>åŠ¨æ€å¤©èŠ±æ¿ï¼š</strong>çº¢çº¿ä¼šéšæ—¶é—´ä¸æ–­ä¸‹é™ï¼Œå‹ç¼© AI çš„ç”Ÿå­˜ç©ºé—´ã€‚</li>
                    <li><strong>ç©å®¶è·èƒœï¼š</strong>AI æ”¾ç½®æ–¹å—åï¼Œåªè¦æ–¹å—ä»»ä½•éƒ¨åˆ†è§¦ç¢°æˆ–è¶Šè¿‡çº¢çº¿ï¼Œä½ å°±èµ¢äº†ã€‚</li>
                    <li><strong>ç©å®¶å¤±è´¥ï¼š</strong>AI åœ¨è§¦é¡¶å‰æ¶ˆé™¤çš„è¡Œæ•°è¾¾åˆ°å…³å¡ç›®æ ‡ã€‚</li>
                </ul>
                <p><strong>æŠ€å·§ï¼š</strong>é•¿æ¡(I)ä¼šå¸® AI æ¶ˆè¡Œç»­å‘½ï¼Œå°½é‡å–‚ç»™å®ƒ S/Z/T æˆ–ç‰¹æ®Šçš„é‡‘å—å½¢çŠ¶æ¥å¹²æ‰°å®ƒï¼</p>
            </div>
            <button id="btn-back-howto" class="btn">BACK</button>
        `),this.overlays.settings=this.createOverlay("settings-overlay",`
            <h2>è®¾ç½®</h2>
            <div class="settings-content">
                <div class="setting-item">
                    <label>ç”µè„‘éš¾åº¦</label>
                    <div class="difficulty-btns">
                        <button id="diff-easy" class="btn diff-btn">ç®€å•</button>
                        <button id="diff-normal" class="btn diff-btn active">æ™®é€š</button>
                        <button id="diff-hard" class="btn diff-btn">å›°éš¾</button>
                        <button id="diff-god" class="btn diff-btn">åœ°ç‹±</button>
                    </div>
                </div>
            </div>
            <button id="btn-back-settings" class="btn">BACK</button>
        `),this.overlays.levels=this.createOverlay("levels-overlay",`
            <h2>SELECT LEVEL</h2>
            <div class="level-grid" id="level-grid">
                <!-- Generated via JS -->
            </div>
            <button id="btn-back-levels" class="btn back">BACK</button>
        `),this.overlays.pause=this.createOverlay("pause-overlay",`
            <h2>PAUSED</h2>
            <button id="btn-resume" class="btn primary">RESUME</button>
            <button id="btn-restart-pause" class="btn">RESTART</button>
            <button id="btn-menu-pause" class="btn">MAIN MENU</button>
        `),this.overlays.win=this.createOverlay("win-overlay",`
            <h1 class="win">VICTORY!</h1>
            <p>The AI Topped Out.</p>
            <button id="btn-next-level" class="btn primary">NEXT LEVEL</button>
            <button id="btn-menu-win" class="btn">MAIN MENU</button>
        `),this.overlays.lose=this.createOverlay("lose-overlay",`
            <h1 class="lose">DEFEAT</h1>
            <p>The AI Survived your attacks.</p>
            <button id="btn-retry" class="btn primary">RETRY</button>
            <button id="btn-menu-lose" class="btn">MAIN MENU</button>
        `);const e=document.createElement("div");e.id="hud-overlay",e.className="overlay hidden",e.style.pointerEvents="none",e.innerHTML=`
            <div class="hud-top">
                <div class="hud-score">Level: <span id="hud-level">1</span></div>
                <div class="hud-target">Target: <span id="hud-target">0</span>/10 Lines</div>
            </div>
        `,this.app.appendChild(e),this.overlays.hud=e}createAiLogPanel(){const e=document.createElement("div");e.id="ai-log-panel",e.className="ai-log-panel hidden",e.innerHTML=`
            <div class="ai-log-header">
                <div class="ai-log-title">AI LOG</div>
                <div class="ai-log-actions">
                    <button id="ai-log-copy" class="ai-log-btn">COPY</button>
                    <button id="ai-log-close" class="ai-log-btn">CLOSE</button>
                </div>
            </div>
            <textarea id="ai-log-text" class="ai-log-text" readonly></textarea>
            <div class="ai-log-hint">Toggle: S</div>
        `,this.app.appendChild(e),this.aiLogTextArea=e.querySelector("#ai-log-text");const t=e.querySelector("#ai-log-copy");t==null||t.addEventListener("click",async()=>{var a;const s=((a=this.aiLogTextArea)==null?void 0:a.value)??"";this.aiLogTextArea&&(this.aiLogTextArea.focus(),this.aiLogTextArea.select());try{await navigator.clipboard.writeText(s),t.textContent="COPIED",setTimeout(()=>t.textContent="COPY",800)}catch{this.aiLogTextArea&&(this.aiLogTextArea.focus(),this.aiLogTextArea.select())}});const i=e.querySelector("#ai-log-close");return i==null||i.addEventListener("click",()=>this.setAiLogVisible(!1)),e}createOverlay(e,t){const i=document.createElement("div");return i.id=e,i.className="overlay hidden",i.innerHTML=t,this.app.appendChild(i),i}show(e){Object.values(this.overlays).forEach(t=>t.classList.add("hidden")),this.overlays[e]&&this.overlays[e].classList.remove("hidden"),e==="game"&&this.overlays.hud.classList.remove("hidden")}hideAll(){Object.values(this.overlays).forEach(e=>e.classList.add("hidden"))}toggleAiLogPanel(){this.setAiLogVisible(!this.aiLogVisible)}setAiLogVisible(e){this.aiLogVisible=e,e?this.aiLogPanel.classList.remove("hidden"):this.aiLogPanel.classList.add("hidden")}isAiLogVisible(){return this.aiLogVisible}setAiLog(e){this.aiLogTextArea&&(this.aiLogTextArea.value=e,this.aiLogTextArea.scrollTop=this.aiLogTextArea.scrollHeight)}on(e,t,i){const s=document.getElementById(e);s&&s.addEventListener(t,i)}updateHUD(e,t,i){const s=document.getElementById("hud-level"),a=document.getElementById("hud-target");s&&(s.textContent=e.toString()),a&&(a.textContent=t.toString()+"/"+i.toString())}generateLevelGrid(e,t){const i=document.getElementById("level-grid");if(i){i.innerHTML="";for(let s=1;s<=e;s++){const a=document.createElement("button");a.className="level-btn",a.textContent=s.toString(),a.onclick=()=>t(s),i.appendChild(a)}}}}const se=document.querySelector("#app");se.innerHTML=`
  <canvas id="game-canvas" width="800" height="600"></canvas>
  <button id="audio-btn">ğŸ”‡</button>
`;const H=document.getElementById("game-canvas"),C=new K(H),v=new Z(C);v.appVersion="v0.0.0+bc98825";const M=new ee(H,C),p=new te,u=new ie,W=()=>{p.init(),H.removeEventListener("mousedown",W),H.removeEventListener("touchstart",W),window.removeEventListener("keydown",W)};H.addEventListener("mousedown",W);H.addEventListener("touchstart",W);window.addEventListener("keydown",W);const V=document.getElementById("audio-btn");V.addEventListener("click",h=>{h.stopPropagation(),p.init(),p.toggleBgm(),p.isBgmPlaying()?V.textContent="ğŸ”Š":V.textContent="ğŸ”‡"});let E="NORMAL";u.on("btn-start","click",()=>{u.show("game"),v.setDifficulty(E),v.start(),p.playSelect()});u.on("btn-levels","click",()=>{u.generateLevelGrid(20,h=>{u.show("game"),v.setDifficulty(E),v.loadLevel(I.generateLevel(h)),p.playSelect()}),u.show("levels"),p.playSelect()});u.on("btn-howto","click",()=>{u.show("howto"),p.playSelect()});u.on("btn-back-howto","click",()=>{u.show("menu"),p.playSelect()});u.on("btn-settings","click",()=>{u.show("settings"),p.playSelect()});u.on("btn-back-settings","click",()=>{u.show("menu"),p.playSelect()});const _=()=>{document.querySelectorAll(".diff-btn").forEach(e=>e.classList.remove("active"));const h=document.getElementById(`diff-${E.toLowerCase()}`);h&&h.classList.add("active")};u.on("diff-easy","click",()=>{E="EASY",_(),p.playSelect()});u.on("diff-normal","click",()=>{E="NORMAL",_(),p.playSelect()});u.on("diff-hard","click",()=>{E="HARD",_(),p.playSelect()});u.on("diff-god","click",()=>{E="GOD",_(),p.playSelect()});u.on("btn-back-levels","click",()=>{u.show("menu"),p.playSelect()});u.on("btn-resume","click",()=>{u.show("game"),p.playSelect()});u.on("btn-restart-pause","click",()=>{u.show("game"),v.start(I.generateLevel(v.data.level)),p.playSelect()});u.on("btn-menu-pause","click",()=>{u.show("menu"),p.playSelect()});u.on("btn-next-level","click",()=>{const h=v.data.level;v.loadLevel(I.generateLevel(h+1)),u.show("game"),p.playSelect()});u.on("btn-menu-win","click",()=>{u.show("menu"),p.playSelect()});u.on("btn-retry","click",()=>{v.loadLevel(I.generateLevel(v.data.level)),u.show("game"),p.playSelect()});u.on("btn-menu-lose","click",()=>{u.show("menu"),p.playSelect()});M.on("selectPiece",h=>{p.playSelect(),v.selectPiece(h)});M.on("restart",()=>{p.playSelect(),v.start(I.generateLevel(v.data.level))});M.on("pause",()=>{u.show("pause"),p.playSelect()});M.on("menu",()=>{v.state!==0&&(u.show("pause"),p.playSelect())});M.on("toggleDebug",()=>{v.toggleDebugHud()});M.on("toggleVersion",()=>{v.toggleVersionHud()});M.on("toggleAiLog",()=>{u.toggleAiLogPanel(),v.setDecisionLogVisible(u.isAiLogVisible()),u.isAiLogVisible()&&u.setAiLog(v.getLastDecisionLog())});v.on("pieceLocked",()=>{p.playDrop(),C.animator.triggerShake(100)});v.on("linesCleared",h=>{p.playClear(),u.updateHUD(v.data.level,v.data.linesCleared,v.data.targetLines);const e=C.layout.gridX+C.layout.gridWidth/2,t=C.layout.gridY+C.layout.gridHeight/2;C.animator.spawnParticles(e,t,"#ffcc00",20*h),C.animator.spawnText(e,t,`+${h}`,"#fff"),C.animator.triggerShake(300)});v.on("levelLoaded",h=>{u.updateHUD(h.id,0,h.targetLines)});v.on("gameOver",h=>{p.playGameOver(h==="win"),h==="win"?u.show("win"):u.show("lose")});v.on("aiTrace",h=>{u.isAiLogVisible()&&u.setAiLog(h)});let Y=0;function X(h){const e=h-Y;Y=h,v.update(e),v.render(),requestAnimationFrame(X)}requestAnimationFrame(X);
